<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emirates Skills 2026 - Complete Training Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .countdown {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: inline-block;
        }

        .countdown-number {
            font-size: 3em;
            font-weight: bold;
            color: #ffd700;
        }

        .nav-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #1e3c72;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e0e0e0;
        }

        .nav-tab.active {
            background: #1e3c72;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #2a5298;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30,60,114,0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .zone-section {
            margin-bottom: 30px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .zone-header {
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zone-red { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .zone-yellow { background: linear-gradient(135deg, #f39c12, #f1c40f); }
        .zone-green { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .skill-card {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .skill-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1e3c72;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assessment-grid {
            display: grid;
            gap: 10px;
        }

        .assessment-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .assessment-item:hover {
            background: #e9ecef;
        }

        .assessment-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
        }

        .assessment-text {
            flex: 1;
            font-size: 0.95em;
        }

        .progress-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .progress-complete { background: #d4edda; color: #155724; }
        .progress-partial { background: #fff3cd; color: #856404; }
        .progress-none { background: #f8d7da; color: #721c24; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container canvas {
            max-height: 400px;
        }

        .feedback-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 100px;
            margin-top: 10px;
        }

        .report-header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .report-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }

        .report-section h3 {
            color: #1e3c72;
            border-bottom: 3px solid #1e3c72;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .hours-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .hours-log-table th,
        .hours-log-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .hours-log-table th {
            background: #1e3c72;
            color: white;
            font-weight: bold;
        }

        .hours-log-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .hours-log-table tr:hover {
            background: #e9ecef;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .nav-tabs, .action-buttons, .control-panel {
                display: none !important;
            }
            .container {
                box-shadow: none;
            }
        }

        .import-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px dashed #1e3c72;
        }

        .student-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .student-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .student-info h3 {
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .student-stats {
            display: flex;
            gap: 20px;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #1e3c72;
        }

        .modal-close {
            background: #dc3545;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .progress-stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
        }

        .progress-stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="font-size: 4em; animation: spin 2s linear infinite;">‚è≥</div>
            <div style="margin-top: 20px; font-size: 1.3em; font-weight: bold;" id="loadingText">Processing...</div>
            <div style="margin-top: 10px; color: #666;">Please wait</div>
        </div>
    </div>

    <!-- Progress Chart Modal -->
    <div id="progressModal" class="modal-overlay" onclick="closeProgressModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">Skill Progress Over Time</h2>
                <button class="modal-close" onclick="closeProgressModal()">&times;</button>
            </div>
            <div id="modalBody">
                <div class="progress-stats" id="progressStats"></div>
                <div style="margin-top: 20px;">
                    <canvas id="progressChartCanvas"></canvas>
                </div>
                <div id="progressTable" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üèÜ Emirates Skills National Competition 2026</h1>
            <p style="font-size: 1.2em; margin: 10px 0;">Complete Training Management System - Health & Social Care</p>
            <div class="countdown">
                <div>Competition in <span class="countdown-number" id="daysLeft">65</span> Days</div>
                <div style="font-size: 0.9em; margin-top: 5px;">April 13-15, 2026</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="nav-tab" onclick="switchTab('assessment')">‚úÖ Assessment</button>
            <button class="nav-tab" onclick="switchTab('hours')">‚è∞ Training Hours</button>
            <button class="nav-tab" onclick="switchTab('reports')">üìã Student Reports</button>
            <button class="nav-tab" onclick="switchTab('analytics')">üìà Analytics</button>
            <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Settings & Export</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value" id="totalStudents">13</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Training Hours</div>
                    <div class="stat-value" id="avgHours">96.3</div>
                    <div class="stat-label" style="font-size: 0.8em;">Target: 200 hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Practice Reps</div>
                    <div class="stat-value" id="totalReps">0</div>
                    <div class="stat-label" style="font-size: 0.8em;" id="avgRepsPerStudent">0 avg per student</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Students at Target (200+ hrs)</div>
                    <div class="stat-value" id="studentsAtTarget">0</div>
                    <div class="stat-label" style="font-size: 0.8em;" id="targetPercentage">0% of class</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Skills</div>
                    <div class="stat-value">11</div>
                    <div class="stat-label" style="font-size: 0.8em;">4 Red | 4 Yellow | 3 Green</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Days Until Competition</div>
                    <div class="stat-value" id="daysLeftStat">65</div>
                </div>
            </div>

            <h2 style="margin: 30px 0 20px 0; color: #1e3c72;">Student Roster</h2>
            <div id="studentRoster"></div>

            <h2 style="margin: 30px 0 20px 0; color: #1e3c72;">Progress to 200-Hour Target</h2>
            <div id="hoursProgressBars" style="margin-bottom: 30px;"></div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px; color: #1e3c72;">Training Hours Overview</h3>
                <canvas id="overviewChart"></canvas>
            </div>
        </div>

        <!-- ASSESSMENT TAB -->
        <div id="assessment" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <label for="studentSelect">Select Student</label>
                    <select id="studentSelect" onchange="loadStudentAssessment()">
                        <option value="">-- Choose Student --</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="skillSelect">Quick Jump to Skill</label>
                    <select id="skillSelect" onchange="jumpToSkill()">
                        <option value="">-- All Skills --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn btn-success" onclick="saveAllProgress()">üíæ Save Progress</button>
                    <button class="btn btn-info" onclick="calculateProgress()">üîÑ Update Progress</button>
                </div>
            </div>

            <div id="assessmentContent">
                <p style="text-align: center; color: #666; font-size: 1.2em; padding: 40px;">
                    Select a student to begin assessment
                </p>
            </div>
        </div>

        <!-- TRAINING HOURS TAB -->
        <div id="hours" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <label for="hoursStudent">Student</label>
                    <select id="hoursStudent">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="hoursDate">Date</label>
                    <input type="date" id="hoursDate">
                </div>
                <div class="control-group">
                    <label for="hoursAmount">Hours</label>
                    <input type="number" id="hoursAmount" min="0" max="24" step="0.5" placeholder="0.0">
                </div>
                <div class="control-group">
                    <label for="hoursNotes">Notes (Optional)</label>
                    <input type="text" id="hoursNotes" placeholder="e.g., Red Zone practice">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="logHours()">‚ûï Log Hours</button>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px; color: #1e3c72;">Training Hours by Student</h3>
                <canvas id="hoursChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px; color: #1e3c72;">Hours Log</h3>
                <table class="hours-log-table" id="hoursLogTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Student</th>
                            <th>Hours</th>
                            <th>Notes</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="hoursLogBody"></tbody>
                </table>
            </div>
        </div>

        <!-- STUDENT REPORTS TAB -->
        <div id="reports" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <label for="reportType">Report Type</label>
                    <select id="reportType" onchange="handleReportTypeChange()">
                        <option value="individual">Individual Student Report</option>
                        <option value="group">Group/Class Report</option>
                        <option value="comparison">Student Comparison Report</option>
                    </select>
                </div>
                <div class="control-group" id="studentSelectGroup">
                    <label for="reportStudent">Select Student</label>
                    <select id="reportStudent" onchange="generateStudentReport()">
                        <option value="">-- Choose Student --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateReport()">üìä Generate Report</button>
                    <button class="btn btn-success" onclick="exportStudentReportExcel()">üìä Export Excel</button>
                    <button class="btn" onclick="exportStudentReportHTML()" style="background: #17a2b8; color: white;">üíæ Save HTML</button>
                    <button class="btn" onclick="printReport()" style="background: #6c757d; color: white;">üñ®Ô∏è Print</button>
                    <button class="btn btn-warning" onclick="exportAllStudentsExcel()">üìÖ All Students Excel</button>
                </div>
            </div>

            <div id="reportContent"></div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="control-panel">
                <div class="control-group">
                    <label for="analyticsStudent">Track Individual Student Progress</label>
                    <select id="analyticsStudent" onchange="showStudentProgressAnalytics()">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
            </div>

            <div id="individualProgressSection" style="display: none; margin-bottom: 30px;">
                <h3 style="color: #1e3c72; margin-bottom: 20px;">Individual Progress Overview</h3>
                <div class="stats-grid" id="individualProgressStats"></div>
                <div class="chart-container">
                    <h4 style="margin-bottom: 15px;">Skills Assessment Frequency</h4>
                    <canvas id="individualSkillsChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px; color: #1e3c72;">Skills Mastery by Zone</h3>
                <canvas id="zoneProgressChart"></canvas>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px; color: #1e3c72;">Top Performers</h3>
                    <canvas id="topPerformersChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 style="margin-bottom: 20px; color: #1e3c72;">Training Hours Distribution</h3>
                    <canvas id="hoursDistributionChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px; color: #1e3c72;">Progress Timeline</h3>
                <canvas id="progressTimelineChart"></canvas>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #1e3c72;">‚öôÔ∏è Settings & Data Management</h2>

            <!-- Student Management Section -->
            <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">üë• Student Management</h3>
                <p style="color: #666; margin-bottom: 20px;">Exclude students from competition (data preserved) or permanently delete</p>
                
                <div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                    <strong>‚ö†Ô∏è Note:</strong> Excluded students are hidden from reports/stats but data is saved. You can re-activate them anytime. Delete permanently removes all data.
                </div>
                
                <table class="hours-log-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Student Name</th>
                            <th style="width: 15%;">Hours</th>
                            <th style="width: 15%;">Status</th>
                            <th style="width: 30%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentManagementBody">
                    </tbody>
                </table>
            </div>

            <!-- Bulk Training Hours Section -->
            <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">‚ûï Add Training Hours to Multiple Students</h3>
                <p style="color: #666; margin-bottom: 20px;">Quickly log training hours for students who attended the same session</p>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Training Date:</label>
                    <input type="date" id="bulkHoursDate" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 200px;" />
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Hours to Add:</label>
                    <input type="number" id="bulkHoursAmount" min="0.5" max="24" step="0.5" value="2" 
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 150px;" 
                           oninput="if(this.value > 24) this.value = 24; if(this.value < 0) this.value = 0;" />
                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">Max 24 hours per day</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Notes (optional):</label>
                    <input type="text" id="bulkHoursNotes" placeholder="e.g., CPR training session" 
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;" />
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: bold;">Select Students:</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                            <input type="checkbox" id="selectAllStudents" onchange="toggleAllStudents()" 
                                   style="width: 18px; height: 18px; cursor: pointer;" />
                            <label for="selectAllStudents" style="cursor: pointer; font-weight: bold;">Select All</label>
                        </div>
                        <div id="bulkStudentsCheckboxes" style="display: contents;"></div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addBulkHours()" style="padding: 12px 30px; font-size: 1.1em;">
                    ‚úÖ Add Hours to Selected Students
                </button>
                
                <div id="bulkHoursPreview" style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 5px; display: none;">
                    <strong>Preview:</strong>
                    <p id="bulkHoursPreviewText" style="margin: 10px 0 0 0;"></p>
                </div>
            </div>
            
            <h2 style="margin: 30px 0 20px 0; color: #1e3c72;">Data Management</h2>
            
            <div class="import-section">
                <h3 style="margin-bottom: 15px;">üì• Import Old Dashboard Data</h3>
                <p style="margin-bottom: 10px;">Import your assessment data from the old GitHub dashboard (Yellow Zone skills only).</p>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <strong>üìã How to Export from Old Dashboard:</strong>
                    <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Open old dashboard: <a href="https://nourz-dotcom.github.io/emirates-skills-assessment/" target="_blank">https://nourz-dotcom.github.io/emirates-skills-assessment/</a></li>
                        <li>Press <strong>F12</strong> to open browser console</li>
                        <li>Paste this code and press Enter:
                            <code style="display: block; background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; font-size: 0.9em;">
var oldData = localStorage.getItem('assessmentData');<br>
if (oldData) {<br>
&nbsp;&nbsp;var blob = new Blob([oldData], {type: 'application/json'});<br>
&nbsp;&nbsp;var url = URL.createObjectURL(blob);<br>
&nbsp;&nbsp;var a = document.createElement('a');<br>
&nbsp;&nbsp;a.href = url; a.download = 'old-dashboard-data.json';<br>
&nbsp;&nbsp;a.click();<br>
}
                            </code>
                        </li>
                        <li>Save the downloaded <strong>old-dashboard-data.json</strong> file</li>
                    </ol>
                </div>

                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #17a2b8;">
                    <strong>‚ÑπÔ∏è What Gets Imported:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>‚úÖ Yellow Zone: Recovery Position (all checkboxes)</li>
                        <li>‚úÖ Yellow Zone: Burn Management (all checkboxes)</li>
                        <li>‚úÖ Yellow Zone: Triangular Bandage Sling (all checkboxes)</li>
                        <li>‚úÖ Yellow Zone: SAM Splint/Ankle Fracture (all checkboxes)</li>
                        <li>‚ùå Red Zone skills (not in old dashboard - assess fresh)</li>
                        <li>‚ùå Green Zone skills (not in old dashboard - assess fresh)</li>
                    </ul>
                </div>

                <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px;">
                    <input type="file" id="importFile" accept=".json" style="flex: 1;">
                    <button class="btn btn-info" onclick="importOldData()">üì• Import Old Data</button>
                    <a href="IMPORT_GUIDE.md" download style="text-decoration: none;">
                        <button class="btn btn-primary">üìñ Download Full Import Guide</button>
                    </a>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveAllData()">üíæ Save All Data</button>
                <button class="btn btn-primary" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="btn btn-warning" onclick="exportBackup()">üíæ Download Backup</button>
                <button class="btn btn-info" onclick="loadBackup()">üì• Load Backup</button>
                <button class="btn btn-danger" onclick="confirmClearAll()">üóëÔ∏è Clear All Data</button>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px; color: #1e3c72;">System Information</h3>
                <div id="systemInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA STRUCTURE ====================
        const TARGET_TRAINING_HOURS = 200;

        const SKILLS_DATA = {
            'Red Zone': [
                {
                    name: 'Severe Bleeding - Using Tourniquet',
                    items: [
                        'Checked for scene safety before approaching',
                        'Wear gloves / PPE',
                        'Assessed responsiveness of the casualty',
                        'Called for help/emergency services to take patient to hospital',
                        'Reassured and communicated with casualty (if conscious)',
                        'Identified life-threatening bleeding',
                        'Check for location and severity of bleeding',
                        'Applied direct pressure to wound initially',
                        'Selected appropriate tourniquet and site',
                        'Placed tourniquet 2-3 inches above bleeding site',
                        'Ensured tourniquet is not over a joint (e.g., knee or elbow)',
                        'Tightened tourniquet until bleeding stopped',
                        'Did not cover the tourniquet (kept it visible)',
                        'Noted or stated the time of application',
                        'Maintained calm, confident demeanor',
                        'Followed logical sequence with no unnecessary delays',
                        'Disposes waste, removes gloves',
                        'Task completed within appropriate time frame'
                    ]
                },
                {
                    name: 'Severe Bleeding - On Mannequin (Compression Pad)',
                    items: [
                        'Checked scene safety before approaching',
                        'Wore gloves / PPE properly',
                        'Checked casualty\'s responsiveness (verbal and gentle physical check)',
                        'Introduced self and reassured the casualty calmly',
                        'Asked about pain location and what happened',
                        'Located the wound and assessed bleeding severity',
                        'Applied direct pressure with a clean dressing or hand',
                        'Communicated continuously ("I\'m applying pressure to stop the bleeding.")',
                        'Added a compression pad once bleeding slowed',
                        'Applied firm, consistent pressure over the pad',
                        'Secured the dressing in place without restricting circulation',
                        'Checked for continued bleeding and adjusted pressure if needed',
                        'Monitored casualty\'s comfort and reassured throughout',
                        'Maintained calm, confident, and clear communication',
                        'Disposed of waste safely and removed gloves properly',
                        'Completed procedure logically and within appropriate time frame'
                    ]
                },
                {
                    name: 'Spinal Immobilization',
                    items: [
                        'Checked for scene safety',
                        'Wear gloves / use PPE',
                        'Ensure minimal movement of casualty',
                        'Assess responsiveness',
                        'Reassure and communicate with casualty',
                        'Team communicates clearly and chooses leader',
                        'Maintain manual in-line stabilization',
                        'Team verbalizes plan and assigns roles',
                        'Assessment before immobilization (PMS)',
                        'Applying cervical collar without moving head',
                        'Coordinate as team leader for log roll',
                        'Log rolled with spinal alignment maintained',
                        'Position casualty centrally on board',
                        'Apply chest, hip, leg straps correctly',
                        'Applied head blocks/padding appropriately',
                        'Confirmed full immobilization',
                        'Maintained calm, confident manner',
                        'Re-checks for PMS',
                        'Group works smoothly in sync'
                    ]
                },
                {
                    name: 'CPR - Cardiopulmonary Resuscitation',
                    items: [
                        'Check scene safety before approaching',
                        'Check responsiveness - tap shoulders and shout',
                        'Call for help/activate emergency services',
                        'Position patient on firm, flat surface',
                        'Open airway using head-tilt chin-lift',
                        'Check for breathing (look, listen, feel) - max 10 seconds',
                        'Give 2 rescue breaths (1 second each, watch for chest rise)',
                        'Hand placement: center of chest, lower half of sternum',
                        'Body position: shoulders directly over hands, arms straight',
                        'Compression depth: 2-2.4 inches (5-6 cm)',
                        'Compression rate: 100-120 per minute',
                        'Allow full chest recoil between compressions',
                        'Minimize interruptions in compressions',
                        'Maintain ratio: 30 compressions to 2 breaths',
                        'Continue cycles until help arrives or patient recovers',
                        'Switch compressors every 2 minutes if multiple rescuers',
                        'Reassess patient after every 5 cycles (2 minutes)',
                        'Maintain proper infection control/use barrier devices for breaths',
                        'Disposed of waste and removed gloves properly'
                    ]
                }
            ],
            'Yellow Zone': [
                {
                    name: 'Ankle Fracture Splinting',
                    items: [
                        'Hand hygiene and gloves',
                        'Explains procedure',
                        'Selects proper foam splint',
                        'Checks PMS before splinting',
                        'Positions limb correctly',
                        'Molds splint properly',
                        'Adds padding if needed',
                        'Secures splint with figure of 8 on ankle',
                        'Secures splint on sides of legs',
                        'Ensure splint is secured and fitted well',
                        'Rechecks PMS after splinting',
                        'Reassures person and keeps calm',
                        'Ensures patient comfort',
                        'Disposes waste, removes gloves',
                        'Hand hygiene after',
                        'Communicates clearly'
                    ]
                },
                {
                    name: 'Triangular Bandage - Shoulder Sprain',
                    items: [
                        'Hand hygiene and gloves',
                        'Explains procedure',
                        'Asking patient: What happened?',
                        'Assess for pain, swelling, limited movements',
                        'Positions patient correctly',
                        'Folds/applies bandage properly',
                        'Supports injured area effectively',
                        'Secures ends neatly and safely',
                        'Make sure tie is not on spine and tucked in',
                        'Reassures person and keeps calm',
                        'Ensures patient comfort',
                        'Removes gloves and hand hygiene',
                        'Communicates clearly'
                    ]
                },
                {
                    name: 'Recovery Position',
                    items: [
                        'Checks scene safety',
                        'Hand hygiene and gloves',
                        'Assesses responsiveness (taps and shouts)',
                        'Opens airway (head tilt-chin lift), checks breathing 10 sec',
                        'Calls for help/emergency services',
                        'Removes glasses or bulky items',
                        'Bends nearest arm at elbow 90¬∞, palm up',
                        'Brings far arm across chest, back of hand to cheek',
                        'Grasps far leg and rolls patient gently',
                        'Adjusts upper leg at right angle',
                        'Tilts head back to keep airway open',
                        'Monitors breathing',
                        'Hand hygiene and gloves',
                        'Ensures comfort and warmth'
                    ]
                },
                {
                    name: 'Burn Management',
                    items: [
                        'Checked scene safety before approaching',
                        'Wore gloves / PPE properly',
                        'Checked casualty\'s responsiveness',
                        'Introduced self and reassured casualty',
                        'Asked about pain level and how injury happened',
                        'Identified type and location of burn',
                        'Cooled burn with running cool water 10-20 min',
                        'Applied burn gel evenly after cooling',
                        'Gently removed jewelry/tight items near burn',
                        'Covered burn with sterile non-stick dressing',
                        'Avoided bursting blisters',
                        'Reassured casualty throughout',
                        'Disposed waste and removed gloves',
                        'Maintained calm, logical sequence',
                        'Completed task within time frame'
                    ]
                }
            ],
            'Green Zone': [
                {
                    name: 'Nosebleed Management',
                    items: [
                        'Ensures area is safe, uses gloves',
                        'Asking: What happened?',
                        'Asking: How long has bleeding been going on?',
                        'Asking: Did you swallow blood or feel nauseous?',
                        'Reassures person and keeps calm',
                        'Positions person sitting upright, head forward',
                        'Advises not to tilt head backward',
                        'Pinches soft part of nose below bridge',
                        'Maintains pressure 10 min without checking',
                        'Encourages breathing through mouth',
                        'Applies cold compress (not direct skin contact)',
                        'Checks after 10 min; repeats if continues',
                        'Refers for medical help if doesn\'t stop after 20 min',
                        'Removes gloves and hand hygiene'
                    ]
                },
                {
                    name: 'Minor Bleeding Management',
                    items: [
                        'Ensures area is safe, uses gloves',
                        'Reassures person and explains actions',
                        'Asks: What happened?',
                        'Asks: How long has it been bleeding?',
                        'Checks wound for debris',
                        'Applies direct pressure with sterile gauze',
                        'Maintains pressure until bleeding stops',
                        'Elevates injured part if appropriate',
                        'Clean wound with saline and gauze',
                        'Applies clean dressing after bleeding stops',
                        'Advises to monitor for infection signs',
                        'Removes gloves and hand hygiene'
                    ]
                },
                {
                    name: 'Wrist Sprain Management',
                    items: [
                        'Hand hygiene and wear gloves',
                        'Reassures person and explains actions',
                        'Asks: What happened?',
                        'Asks: Can you move wrist? / Did you hear a pop?',
                        'Checks for swelling, bruising, deformity',
                        'Check PMS (pulse, motor, sensation)',
                        'Educate patient about resting the joint',
                        'Applies cold compress (no direct skin contact)',
                        'Removes ice after 15-20 minutes',
                        'Wraps in alternating loops forming secure "8"',
                        'Maintains even pressure, not too tight',
                        'Elevates hand above heart level if appropriate',
                        'Re-checks PMS after compression',
                        'Advises to rest and monitor',
                        'Removes gloves and hand hygiene'
                    ]
                }
            ]
        };

        const STUDENTS = [
            { id: 1, name: "AMNA MOHAMED ABDULLA SALEM ALHAMMADI", hours: 111 },
            { id: 2, name: "Fatima Khaled Ali Falah Al Ahbabi", hours: 90 },
            { id: 3, name: "DHBIA AHMED ABDULLAH HUMAID ALMEMARI", hours: 109 },
            { id: 4, name: "Fatema Dhafer Mubarak Saeed Alameri", hours: 104 },
            { id: 5, name: "Alyazia Ebrahim Ali Mohamed Al Zaabi", hours: 101 },
            { id: 6, name: "MARIAM THAMIR RASHID MOHAMMED ALNAQBI", hours: 102 },
            { id: 7, name: "ROWDA OMAR HASAN ALKAMALI ALBLOOSHI", hours: 108 },
            { id: 8, name: "AMNA ABDEL AZEZ JUMA ALJASMI ALALI", hours: 99 },
            { id: 9, name: "Fatima Ibrahim Abdulla Ali Alraeesi", hours: 95 },
            { id: 10, name: "AAMAL AHMED ABDULLA ALHEBSHI ALHASHMI", hours: 100 },
            { id: 11, name: "HAMDA OBAID KHALFAN OBAID AL HANTOOBI", hours: 95 },
            { id: 12, name: "SHAMMA AADEL ALI SAEED ALSEREIDI", hours: 72 },
            { id: 13, name: "ZAINA MURAD ALI SHAMESALDDIN ALBLOOSHI", hours: 66 }
        ];

        let studentData = {};
        let trainingHoursLog = [];
        let feedbackData = {};

        // ==================== INITIALIZATION ====================
        function initializeApp() {
            // Load saved data first (before initializing defaults)
            loadSavedData();
            
            // Initialize student data structure (only if not already loaded)
            STUDENTS.forEach(student => {
                if (!studentData[student.id]) {
                    studentData[student.id] = {
                        name: student.name,
                        totalHours: student.hours,
                        skills: {},
                        lastUpdated: new Date().toISOString(),
                        excluded: false,
                        excludedDate: null
                    };

                    // Initialize all skills with progress tracking
                    Object.keys(SKILLS_DATA).forEach(zone => {
                        SKILLS_DATA[zone].forEach(skill => {
                            const skillKey = `${zone}_${skill.name}`;
                            studentData[student.id].skills[skillKey] = {
                                zone: zone,
                                skillName: skill.name,
                                completed: Array(skill.items.length).fill(false),
                                lastAssessed: null,
                                assessmentCount: 0,
                                assessmentHistory: [], // Track progress over time
                                firstAssessed: null,
                                bestScore: 0,
                                currentStreak: 0, // Days in a row assessed
                                repCount: 0 // Number of practice repetitions
                            };
                        });
                    });
                }
            });

            populateStudentSelectors();
            populateSkillSelector();
            renderStudentRoster(); // Now renders with loaded data
            updateCountdown();
            renderOverviewChart();
            renderHoursChart();
            updateSystemInfo();
            setInterval(updateCountdown, 60000); // Update countdown every minute
            
            // Auto-save every 5 minutes
            setInterval(saveToLocalStorage, 5 * 60 * 1000);
        }

        function updateCountdown() {
            const competitionDate = new Date('2026-04-13');
            const today = new Date();
            const daysLeft = Math.ceil((competitionDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('daysLeft').textContent = daysLeft;
            document.getElementById('daysLeftStat').textContent = daysLeft;
        }

        function populateStudentSelectors() {
            const selectors = ['studentSelect', 'reportStudent', 'hoursStudent'];
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">-- Choose Student --</option>';
                STUDENTS.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
        }

        function populateSkillSelector() {
            const select = document.getElementById('skillSelect');
            select.innerHTML = '<option value="">-- All Skills --</option>';
            Object.keys(SKILLS_DATA).forEach(zone => {
                SKILLS_DATA[zone].forEach(skill => {
                    const option = document.createElement('option');
                    option.value = `${zone}_${skill.name}`;
                    option.textContent = `${zone}: ${skill.name}`;
                    select.appendChild(option);
                });
            });
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Refresh content based on tab
            if (tabName === 'analytics') {
                renderAllAnalytics();
            } else if (tabName === 'hours') {
                renderHoursLog();
            } else if (tabName === 'settings') {
                renderStudentManagement();
                renderBulkStudentsCheckboxes();
            }
        }

        // ==================== STUDENT ROSTER ====================
        function renderStudentRoster() {
            const roster = document.getElementById('studentRoster');
            roster.innerHTML = '';

            let studentsAtTarget = 0;
            
            // Filter out excluded students
            const activeStudents = getActiveStudents();

            activeStudents.forEach(student => {
                const data = studentData[student.id];
                const totalSkills = Object.keys(SKILLS_DATA).reduce((sum, zone) => sum + SKILLS_DATA[zone].length, 0);
                let completedSkills = 0;

                Object.keys(data.skills).forEach(skillKey => {
                    const skill = data.skills[skillKey];
                    const completedItems = skill.completed.filter(Boolean).length;
                    const totalItems = skill.completed.length;
                    if (completedItems === totalItems && totalItems > 0) {
                        completedSkills++;
                    }
                });

                const progressPercent = ((completedSkills / totalSkills) * 100).toFixed(0);
                const hoursProgress = ((data.totalHours / TARGET_TRAINING_HOURS) * 100).toFixed(0);
                const hoursRemaining = TARGET_TRAINING_HOURS - data.totalHours;
                
                if (data.totalHours >= TARGET_TRAINING_HOURS) {
                    studentsAtTarget++;
                }

                const card = document.createElement('div');
                card.className = 'student-card';
                
                let hoursColor = '#dc3545'; // red
                if (data.totalHours >= TARGET_TRAINING_HOURS) hoursColor = '#28a745'; // green
                else if (data.totalHours >= 150) hoursColor = '#ffc107'; // yellow
                else if (data.totalHours >= 100) hoursColor = '#17a2b8'; // blue

                card.innerHTML = `
                    <div class="student-info">
                        <h3>${student.name}</h3>
                        <div class="student-stats">
                            <span style="color: ${hoursColor};">‚è∞ ${data.totalHours}/${TARGET_TRAINING_HOURS} hours (${hoursProgress}%)</span>
                            ${hoursRemaining > 0 ? `<span style="color: #666;">üìÖ ${hoursRemaining} hrs to target</span>` : '<span style="color: #28a745;">‚úÖ Target reached!</span>'}
                            <span>‚úÖ ${completedSkills}/${totalSkills} skills</span>
                            <span>üìä ${progressPercent}% skills complete</span>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="viewStudentDetails(${student.id})">View Details</button>
                    </div>
                `;
                roster.appendChild(card);
            });

            // Update stats
            document.getElementById('studentsAtTarget').textContent = studentsAtTarget;
            document.getElementById('targetPercentage').textContent = `${((studentsAtTarget/activeStudents.length)*100).toFixed(0)}% of class`;
            
            const avgHours = activeStudents.length > 0 ? (activeStudents.reduce((sum, s) => sum + studentData[s.id].totalHours, 0) / activeStudents.length).toFixed(1) : 0;
            document.getElementById('avgHours').textContent = avgHours;

            // Calculate total reps across all active students and skills
            let totalReps = 0;
            activeStudents.forEach(student => {
                Object.keys(studentData[student.id].skills).forEach(skillKey => {
                    totalReps += (studentData[student.id].skills[skillKey].repCount || 0);
                });
            });
            document.getElementById('totalReps').textContent = totalReps;
            document.getElementById('avgRepsPerStudent').textContent = `${activeStudents.length > 0 ? (totalReps / activeStudents.length).toFixed(1) : 0} avg per student`;
            
            // Update total students count
            document.getElementById('totalStudents').textContent = activeStudents.length;

            // Render progress bars
            renderHoursProgressBars();
        }

        function renderHoursProgressBars() {
            const container = document.getElementById('hoursProgressBars');
            if (!container) return;

            container.innerHTML = '';

            // Sort students by hours (descending)
            const sortedStudents = [...STUDENTS].sort((a, b) => 
                studentData[b.id].totalHours - studentData[a.id].totalHours
            );

            sortedStudents.forEach((student, index) => {
                const hours = studentData[student.id].totalHours;
                const percent = Math.min(100, (hours / TARGET_TRAINING_HOURS) * 100);
                
                let barColor = '#dc3545'; // red
                let status = 'Needs Acceleration';
                if (hours >= TARGET_TRAINING_HOURS) {
                    barColor = '#28a745'; // green
                    status = 'Target Achieved';
                } else if (hours >= 150) {
                    barColor = '#ffc107'; // yellow
                    status = 'Near Target';
                } else if (hours >= 100) {
                    barColor = '#17a2b8'; // blue
                    status = 'Good Progress';
                }

                const barHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <strong style="font-size: 1.05em;">${index + 1}. ${student.name}</strong>
                                <span style="color: #666; margin-left: 10px; font-size: 0.9em;">${status}</span>
                            </div>
                            <div style="font-weight: bold; color: ${barColor};">
                                ${hours} / ${TARGET_TRAINING_HOURS} hrs
                            </div>
                        </div>
                        <div style="background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                            <div style="background: ${barColor}; height: 100%; width: ${percent}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;">
                                <span style="color: white; font-weight: bold; font-size: 0.9em;">${percent.toFixed(1)}%</span>
                            </div>
                            ${percent < 100 ? `
                                <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; font-size: 0.9em;">
                                    ${(TARGET_TRAINING_HOURS - hours)} hrs remaining
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += barHTML;
            });
        }

        function viewStudentDetails(studentId) {
            document.getElementById('studentSelect').value = studentId;
            switchTab('assessment');
            loadStudentAssessment();
        }

        // ==================== PROGRESS CHART MODAL ====================
        let currentProgressChart = null;

        function showProgressChart(skillKey, studentId) {
            const student = STUDENTS.find(s => s.id == studentId);
            const skillData = studentData[studentId].skills[skillKey];
            
            if (!skillData.assessmentHistory || skillData.assessmentHistory.length === 0) {
                showNotification('No assessment history available yet', 'info');
                return;
            }

            // Update modal title
            document.getElementById('modalTitle').textContent = `${student.name} - ${skillData.skillName}`;

            // Calculate statistics
            const history = skillData.assessmentHistory;
            const totalAssessments = history.length;
            const currentScore = history[history.length - 1].percentage;
            const firstScore = history[0].percentage;
            const improvement = (currentScore - firstScore).toFixed(1);
            const avgScore = (history.reduce((sum, h) => sum + h.percentage, 0) / totalAssessments).toFixed(1);
            const highestScore = Math.max(...history.map(h => h.percentage));
            
            // Days practicing
            const firstDate = new Date(history[0].date);
            const lastDate = new Date(history[history.length - 1].date);
            const daysPracticing = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;

            // Display statistics
            document.getElementById('progressStats').innerHTML = `
                <div class="progress-stat-box">
                    <div class="progress-stat-label">Total Assessments</div>
                    <div class="progress-stat-value">${totalAssessments}</div>
                </div>
                <div class="progress-stat-box">
                    <div class="progress-stat-label">Current Score</div>
                    <div class="progress-stat-value">${currentScore}%</div>
                </div>
                <div class="progress-stat-box" style="background: linear-gradient(135deg, ${improvement >= 0 ? '#28a745, #20c997' : '#dc3545, #e74c3c'});">
                    <div class="progress-stat-label">Improvement</div>
                    <div class="progress-stat-value">${improvement > 0 ? '+' : ''}${improvement}%</div>
                </div>
                <div class="progress-stat-box">
                    <div class="progress-stat-label">Highest Score</div>
                    <div class="progress-stat-value">${highestScore}%</div>
                </div>
                <div class="progress-stat-box">
                    <div class="progress-stat-label">Average Score</div>
                    <div class="progress-stat-value">${avgScore}%</div>
                </div>
                <div class="progress-stat-box">
                    <div class="progress-stat-label">Days Practicing</div>
                    <div class="progress-stat-value">${daysPracticing}</div>
                </div>
            `;

            // Create progress chart
            const ctx = document.getElementById('progressChartCanvas').getContext('2d');
            
            // Destroy previous chart if exists
            if (currentProgressChart) {
                currentProgressChart.destroy();
            }

            currentProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map((h, i) => `Session ${i + 1}\n${new Date(h.date).toLocaleDateString()}`),
                    datasets: [
                        {
                            label: 'Score %',
                            data: history.map(h => h.percentage),
                            borderColor: 'rgba(30, 60, 114, 1)',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: 'rgba(30, 60, 114, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Target (100%)',
                            data: Array(history.length).fill(100),
                            borderColor: 'rgba(40, 167, 69, 0.5)',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Progress Over Time',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const h = history[context.dataIndex];
                                    return [
                                        `Score: ${h.score}/${h.total} (${h.percentage}%)`,
                                        `Date: ${new Date(h.date).toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Completion Percentage'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Assessment Sessions'
                            }
                        }
                    }
                }
            });

            // Create detailed history table
            let tableHTML = `
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Assessment History</h3>
                <table class="hours-log-table">
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Date & Time</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            history.forEach((h, index) => {
                const change = index > 0 ? (h.percentage - history[index - 1].percentage).toFixed(1) : '-';
                let changeColor = '#666';
                let changeIcon = '';
                if (index > 0) {
                    if (change > 0) {
                        changeColor = '#28a745';
                        changeIcon = '‚Üë';
                    } else if (change < 0) {
                        changeColor = '#dc3545';
                        changeIcon = '‚Üì';
                    } else {
                        changeIcon = '‚Üí';
                    }
                }

                tableHTML += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>${new Date(h.date).toLocaleString()}</td>
                        <td>${h.score}/${h.total}</td>
                        <td><strong>${h.percentage}%</strong></td>
                        <td style="color: ${changeColor}; font-weight: bold;">
                            ${change !== '-' ? `${changeIcon} ${change > 0 ? '+' : ''}${change}%` : '-'}
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('progressTable').innerHTML = tableHTML;

            // Show modal
            document.getElementById('progressModal').classList.add('active');
        }

        function closeProgressModal(event) {
            if (!event || event.target.id === 'progressModal') {
                document.getElementById('progressModal').classList.remove('active');
                if (currentProgressChart) {
                    currentProgressChart.destroy();
                    currentProgressChart = null;
                }
            }
        }

        // ==================== ASSESSMENT ====================
        function loadStudentAssessment() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                document.getElementById('assessmentContent').innerHTML = `
                    <p style="text-align: center; color: #666; font-size: 1.2em; padding: 40px;">
                        Select a student to begin assessment
                    </p>
                `;
                return;
            }

            const student = STUDENTS.find(s => s.id == studentId);
            const data = studentData[studentId];

            let html = `
                <div style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 15px 0;">Assessment for ${student.name}</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;

            // Calculate progress for each zone
            Object.keys(SKILLS_DATA).forEach(zone => {
                let zoneTotal = 0;
                let zoneCompleted = 0;
                SKILLS_DATA[zone].forEach(skill => {
                    const skillKey = `${zone}_${skill.name}`;
                    const skillData = data.skills[skillKey];
                    zoneTotal += skillData.completed.length;
                    zoneCompleted += skillData.completed.filter(Boolean).length;
                });
                const zonePercent = zoneTotal > 0 ? ((zoneCompleted / zoneTotal) * 100).toFixed(0) : 0;
                
                let zoneColor = '#dc3545';
                if (zonePercent == 100) zoneColor = '#28a745';
                else if (zonePercent >= 70) zoneColor = '#ffc107';
                else if (zonePercent >= 40) zoneColor = '#17a2b8';

                html += `
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <div style="font-size: 0.9em; margin-bottom: 8px; opacity: 0.9;">${zone}</div>
                        <div style="font-size: 2em; font-weight: bold; margin-bottom: 8px;">${zonePercent}%</div>
                        <div style="background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${zoneColor}; height: 100%; width: ${zonePercent}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.85em; margin-top: 5px; opacity: 0.8;">${zoneCompleted}/${zoneTotal} points</div>
                    </div>
                `;
            });

            // Overall progress
            let totalPoints = 0;
            let completedPoints = 0;
            Object.keys(data.skills).forEach(skillKey => {
                const skill = data.skills[skillKey];
                totalPoints += skill.completed.length;
                completedPoints += skill.completed.filter(Boolean).length;
            });
            const overallPercent = totalPoints > 0 ? ((completedPoints / totalPoints) * 100).toFixed(0) : 0;

            html += `
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.5);">
                        <div style="font-size: 0.9em; margin-bottom: 8px; opacity: 0.9;">OVERALL</div>
                        <div style="font-size: 2em; font-weight: bold; margin-bottom: 8px;">${overallPercent}%</div>
                        <div style="background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: white; height: 100%; width: ${overallPercent}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.85em; margin-top: 5px; opacity: 0.8;">${completedPoints}/${totalPoints} total</div>
                    </div>
                </div>
            </div>
            `;

            Object.keys(SKILLS_DATA).forEach(zone => {
                const zoneClass = zone.toLowerCase().replace(' ', '-');
                html += `
                    <div class="zone-section">
                        <div class="zone-header zone-${zoneClass.split('-')[1]}">
                            <span>${zone}</span>
                            <span id="progress-${zoneClass}">${getZoneProgress(studentId, zone)}</span>
                        </div>
                `;

                SKILLS_DATA[zone].forEach(skill => {
                    const skillKey = `${zone}_${skill.name}`;
                    const skillData = data.skills[skillKey];
                    const completedCount = skillData.completed.filter(Boolean).length;
                    const totalCount = skillData.completed.length;
                    const progressPercent = ((completedCount / totalCount) * 100).toFixed(0);

                    let progressClass = 'progress-none';
                    if (progressPercent == 100) progressClass = 'progress-complete';
                    else if (progressPercent > 0) progressClass = 'progress-partial';

                    // Calculate progress trend
                    let trendIcon = '';
                    let trendText = '';
                    if (skillData.assessmentHistory && skillData.assessmentHistory.length >= 2) {
                        const recent = skillData.assessmentHistory.slice(-2);
                        if (recent[1].percentage > recent[0].percentage) {
                            trendIcon = 'üìà';
                            trendText = `+${(recent[1].percentage - recent[0].percentage).toFixed(1)}% improvement`;
                        } else if (recent[1].percentage < recent[0].percentage) {
                            trendIcon = 'üìâ';
                            trendText = `${(recent[1].percentage - recent[0].percentage).toFixed(1)}%`;
                        } else {
                            trendIcon = '‚û°Ô∏è';
                            trendText = 'No change';
                        }
                    }

                    const assessmentCount = skillData.assessmentCount || 0;
                    const bestScore = skillData.bestScore || 0;
                    const bestPercent = ((bestScore / totalCount) * 100).toFixed(0);
                    const repCount = skillData.repCount || 0;

                    html += `
                        <div class="skill-card" id="skill-${skillKey.replace(/ /g, '-')}">
                            <div class="skill-header">
                                <span>${skill.name}</span>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span class="progress-badge ${progressClass}">${completedCount}/${totalCount} (${progressPercent}%)</span>
                                    ${trendIcon ? `<span style="font-size: 0.9em; color: #666;" title="${trendText}">${trendIcon}</span>` : ''}
                                </div>
                            </div>
                            
                            <!-- Visual Progress Bar for this skill -->
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em;">
                                    <span style="color: #666;">Current Progress</span>
                                    <span style="font-weight: bold; color: ${progressPercent == 100 ? '#28a745' : progressPercent >= 70 ? '#ffc107' : '#dc3545'};">
                                        ${progressPercent}%
                                    </span>
                                </div>
                                <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, ${progressPercent == 100 ? '#28a745, #20c997' : progressPercent >= 70 ? '#ffc107, #ffdb4d' : '#dc3545, #ff6b6b'}); height: 100%; width: ${progressPercent}%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.85em;">
                                        ${progressPercent > 10 ? progressPercent + '%' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>üîÑ <strong>Assessments:</strong> ${assessmentCount}x</span>
                                    </div>
                                </div>
                                <div style="padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 0.9em;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>üí™ <strong>Reps:</strong> <span id="repCount-${skillKey.replace(/ /g, '-')}">${repCount}</span></span>
                                        <div style="display: flex; gap: 5px; align-items: center;">
                                            <button class="btn" style="padding: 4px 10px; font-size: 0.9em; background: #dc3545; color: white;" 
                                                onclick="updateRepsTemp(${studentId}, '${skillKey}', -1)">‚àí</button>
                                            <span style="font-weight: bold; min-width: 40px; text-align: center; font-size: 1.1em; color: #1e3c72;" 
                                                id="tempRepCount-${skillKey.replace(/ /g, '-')}">${repCount}</span>
                                            <button class="btn" style="padding: 4px 10px; font-size: 0.9em; background: #28a745; color: white;" 
                                                onclick="updateRepsTemp(${studentId}, '${skillKey}', 1)">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Save/Clear Rep Buttons -->
                            <div id="repButtons-${skillKey.replace(/ /g, '-')}" style="display: none; margin-bottom: 15px; gap: 10px;">
                                <button class="btn btn-success" style="padding: 8px 16px; font-size: 0.9em;" 
                                    onclick="saveReps(${studentId}, '${skillKey}')">
                                    üíæ Save Reps
                                </button>
                                <button class="btn btn-warning" style="padding: 8px 16px; font-size: 0.9em;" 
                                    onclick="clearTempReps(${studentId}, '${skillKey}')">
                                    ‚Ü∫ Reset
                                </button>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">
                                <span>üèÜ <strong>Best Score:</strong> ${bestScore}/${totalCount} (${bestPercent}%)</span>
                                ${skillData.lastAssessed ? `<span>üìÖ <strong>Last:</strong> ${new Date(skillData.lastAssessed).toLocaleDateString()}</span>` : '<span>üìÖ <strong>Not assessed yet</strong></span>'}
                            </div>
                            
                            ${skillData.assessmentHistory && skillData.assessmentHistory.length > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <button class="btn btn-info" style="padding: 8px 16px; font-size: 0.9em;" onclick="showProgressChart('${skillKey.replace(/'/g, "\\'")}', ${studentId})">
                                        üìä View Progress Chart (${skillData.assessmentHistory.length} sessions)
                                    </button>
                                </div>
                            ` : ''}
                            <div class="assessment-grid">
                    `;

                    skill.items.forEach((item, index) => {
                        const isChecked = skillData.completed[index] ? 'checked' : '';
                        html += `
                            <div class="assessment-item">
                                <input type="checkbox" class="assessment-checkbox" 
                                    ${isChecked}
                                    onchange="updateAssessment(${studentId}, '${skillKey}', ${index})">
                                <span class="assessment-text">${item}</span>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                            <div class="feedback-section">
                                <label><strong>Feedback/Notes for ${skill.name}:</strong></label>
                                <textarea class="feedback-textarea" 
                                    id="feedback-${skillKey.replace(/ /g, '-')}"
                                    onchange="saveFeedback(${studentId}, '${skillKey}')"
                                    placeholder="Enter specific feedback, areas for improvement, or notes about this skill...">${feedbackData[studentId]?.[skillKey] || ''}</textarea>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            document.getElementById('assessmentContent').innerHTML = html;
        }

        function updateAssessment(studentId, skillKey, itemIndex) {
            const checkbox = event.target;
            const skillData = studentData[studentId].skills[skillKey];
            const wasChecked = skillData.completed[itemIndex];
            
            skillData.completed[itemIndex] = checkbox.checked;
            
            // Calculate current score
            const currentScore = skillData.completed.filter(Boolean).length;
            const totalItems = skillData.completed.length;
            const scorePercent = ((currentScore / totalItems) * 100).toFixed(1);
            
            // Check if this is a new assessment session (more than 1 hour since last)
            const now = new Date();
            const lastAssessTime = skillData.lastAssessed ? new Date(skillData.lastAssessed) : null;
            const hoursSinceLastAssess = lastAssessTime ? (now - lastAssessTime) / (1000 * 60 * 60) : Infinity;
            
            // If this is a new session (first time or >1 hour gap), record it
            if (!lastAssessTime || hoursSinceLastAssess >= 1) {
                skillData.assessmentCount++;
                
                // Record assessment history
                skillData.assessmentHistory.push({
                    date: now.toISOString(),
                    score: currentScore,
                    total: totalItems,
                    percentage: parseFloat(scorePercent),
                    completedItems: [...skillData.completed]
                });
                
                // Keep only last 50 assessments to avoid huge data
                if (skillData.assessmentHistory.length > 50) {
                    skillData.assessmentHistory = skillData.assessmentHistory.slice(-50);
                }
                
                // Update first assessed date
                if (!skillData.firstAssessed) {
                    skillData.firstAssessed = now.toISOString();
                }
                
                // Update streak (simplified: just count assessments in last 7 days)
                const recentAssessments = skillData.assessmentHistory.filter(a => {
                    const assessDate = new Date(a.date);
                    const daysDiff = (now - assessDate) / (1000 * 60 * 60 * 24);
                    return daysDiff <= 7;
                });
                skillData.currentStreak = recentAssessments.length;
            } else {
                // Just update the last history entry if within same session
                if (skillData.assessmentHistory.length > 0) {
                    const lastEntry = skillData.assessmentHistory[skillData.assessmentHistory.length - 1];
                    lastEntry.score = currentScore;
                    lastEntry.percentage = parseFloat(scorePercent);
                    lastEntry.completedItems = [...skillData.completed];
                }
            }
            
            // Update best score
            if (currentScore > skillData.bestScore) {
                skillData.bestScore = currentScore;
            }
            
            skillData.lastAssessed = now.toISOString();
            studentData[studentId].lastUpdated = now.toISOString();
            
            calculateProgress();
        }

        function updateRepsTemp(studentId, skillKey, change) {
            const skillData = studentData[studentId].skills[skillKey];
            const skillKeyEscaped = skillKey.replace(/ /g, '-');
            
            // Initialize repCount if it doesn't exist
            if (typeof skillData.repCount === 'undefined') {
                skillData.repCount = 0;
            }
            
            // Get current temp value
            const tempElement = document.getElementById(`tempRepCount-${skillKeyEscaped}`);
            let tempValue = parseInt(tempElement.textContent);
            
            // Update temp value
            tempValue = Math.max(0, tempValue + change);
            tempElement.textContent = tempValue;
            
            // Show save/clear buttons if value changed
            const savedValue = skillData.repCount;
            const buttonsDiv = document.getElementById(`repButtons-${skillKeyEscaped}`);
            if (tempValue !== savedValue) {
                buttonsDiv.style.display = 'flex';
                tempElement.style.color = '#ffc107';
                tempElement.style.fontWeight = 'bold';
            } else {
                buttonsDiv.style.display = 'none';
                tempElement.style.color = '#1e3c72';
            }
        }

        function saveReps(studentId, skillKey) {
            const skillData = studentData[studentId].skills[skillKey];
            const skillKeyEscaped = skillKey.replace(/ /g, '-');
            
            // Get temp value and save it
            const tempElement = document.getElementById(`tempRepCount-${skillKeyEscaped}`);
            const newRepCount = parseInt(tempElement.textContent);
            
            skillData.repCount = newRepCount;
            
            // Update saved display
            document.getElementById(`repCount-${skillKeyEscaped}`).textContent = newRepCount;
            
            // Hide buttons
            document.getElementById(`repButtons-${skillKeyEscaped}`).style.display = 'none';
            tempElement.style.color = '#1e3c72';
            
            // Save to storage
            studentData[studentId].lastUpdated = new Date().toISOString();
            saveToLocalStorage();
            
            showNotification(`‚úÖ Reps saved! Total: ${newRepCount}`, 'success');
            
            // Update overview stats
            renderStudentRoster();
        }

        function clearTempReps(studentId, skillKey) {
            const skillData = studentData[studentId].skills[skillKey];
            const skillKeyEscaped = skillKey.replace(/ /g, '-');
            
            // Reset temp to saved value
            const savedValue = skillData.repCount || 0;
            document.getElementById(`tempRepCount-${skillKeyEscaped}`).textContent = savedValue;
            
            // Hide buttons
            document.getElementById(`repButtons-${skillKeyEscaped}`).style.display = 'none';
            document.getElementById(`tempRepCount-${skillKeyEscaped}`).style.color = '#1e3c72';
            
            showNotification('Reset to saved value', 'info');
        }

        function saveFeedback(studentId, skillKey) {
            const textarea = document.getElementById(`feedback-${skillKey.replace(/ /g, '-')}`);
            if (!feedbackData[studentId]) feedbackData[studentId] = {};
            feedbackData[studentId][skillKey] = textarea.value;
            saveToLocalStorage();
            showNotification('Feedback saved!', 'success');
        }

        function jumpToSkill() {
            const skillKey = document.getElementById('skillSelect').value;
            if (skillKey) {
                const element = document.getElementById(`skill-${skillKey.replace(/ /g, '-')}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.style.boxShadow = '0 0 20px rgba(30, 60, 114, 0.5)';
                    setTimeout(() => {
                        element.style.boxShadow = '';
                    }, 2000);
                }
            }
        }

        function getZoneProgress(studentId, zone) {
            const data = studentData[studentId];
            let totalItems = 0;
            let completedItems = 0;

            SKILLS_DATA[zone].forEach(skill => {
                const skillKey = `${zone}_${skill.name}`;
                const skillData = data.skills[skillKey];
                totalItems += skillData.completed.length;
                completedItems += skillData.completed.filter(Boolean).length;
            });

            const percent = totalItems > 0 ? ((completedItems / totalItems) * 100).toFixed(0) : 0;
            return `${completedItems}/${totalItems} (${percent}%)`;
        }

        function calculateProgress() {
            const studentId = document.getElementById('studentSelect').value;
            if (studentId) {
                loadStudentAssessment();
                showNotification('Progress updated!', 'success');
            }
        }

        // ==================== TRAINING HOURS ====================
        function logHours() {
            const studentId = document.getElementById('hoursStudent').value;
            const date = document.getElementById('hoursDate').value;
            const hours = parseFloat(document.getElementById('hoursAmount').value);
            const notes = document.getElementById('hoursNotes').value;

            if (!studentId || !date || !hours) {
                showNotification('Please fill all required fields!', 'error');
                return;
            }
            
            // Validate hours
            if (hours <= 0) {
                alert('‚ùå Hours must be greater than 0');
                return;
            }
            
            if (hours > 24) {
                alert('‚ùå Hours cannot exceed 24 per day. Please check your entry.');
                return;
            }
            
            if (hours > 12) {
                if (!confirm(`‚ö†Ô∏è You entered ${hours} hours.\n\nThis is more than a typical training day.\n\nAre you sure this is correct?`)) {
                    return;
                }
            }

            const student = STUDENTS.find(s => s.id == studentId);
            trainingHoursLog.push({
                id: Date.now(),
                studentId: parseInt(studentId),
                studentName: student.name,
                date: date,
                hours: hours,
                notes: notes,
                timestamp: new Date().toISOString()
            });

            studentData[studentId].totalHours += hours;
            studentData[studentId].lastUpdated = new Date().toISOString();

            // Clear form
            document.getElementById('hoursAmount').value = '';
            document.getElementById('hoursNotes').value = '';

            // Update all displays
            renderHoursLog();
            renderHoursChart();
            renderStudentRoster(); // ‚Üê FIX: Update overview display
            renderAllAnalytics(); // ‚Üê FIX: Update analytics
            saveToLocalStorage();
            showNotification(`‚úÖ ${hours} hours added to ${student.name}!`, 'success');
        }

        function renderHoursLog() {
            const tbody = document.getElementById('hoursLogBody');
            tbody.innerHTML = '';

            // Sort by date descending
            const sortedLog = [...trainingHoursLog].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedLog.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                    <td>${entry.studentName}</td>
                    <td>${entry.hours} hrs</td>
                    <td>${entry.notes || '-'}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9em;" 
                            onclick="deleteHoursEntry(${entry.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteHoursEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                const entry = trainingHoursLog.find(e => e.id === entryId);
                if (entry) {
                    studentData[entry.studentId].totalHours -= entry.hours;
                    studentData[entry.studentId].lastUpdated = new Date().toISOString();
                    trainingHoursLog = trainingHoursLog.filter(e => e.id !== entryId);
                    
                    // Update all displays
                    renderHoursLog();
                    renderHoursChart();
                    renderStudentRoster(); // ‚Üê FIX: Update overview display
                    renderAllAnalytics(); // ‚Üê FIX: Update analytics
                    saveToLocalStorage();
                    showNotification('Entry deleted!', 'success');
                }
            }
        }

        // ==================== REPORTS ====================
        // ==================== REPORTS ====================
        function handleReportTypeChange() {
            const reportType = document.getElementById('reportType').value;
            const studentSelectGroup = document.getElementById('studentSelectGroup');
            
            if (reportType === 'individual') {
                studentSelectGroup.style.display = 'block';
            } else {
                studentSelectGroup.style.display = 'none';
            }
            
            // Clear previous report
            document.getElementById('reportContent').innerHTML = '';
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            
            switch(reportType) {
                case 'individual':
                    generateStudentReport();
                    break;
                case 'group':
                    generateGroupReport();
                    break;
                case 'comparison':
                    generateComparisonReport();
                    break;
                default:
                    generateStudentReport();
            }
        }

        function generateGroupReport() {
            try {
                console.log('üìä Generating group/class report...');
                
                let html = `
                    <div class="report-header">
                        <h2>Class Performance Report</h2>
                        <h3>Emirates Skills 2026 - Health & Social Care</h3>
                        <p>Generated: ${new Date().toLocaleDateString()}</p>
                        <p>Competition Date: April 13-15, 2026</p>
                        <p style="font-size: 0.9em; opacity: 0.9;">Total Students: ${STUDENTS.length}</p>
                    </div>
                `;

                // Class Overview Stats
                const totalHours = STUDENTS.reduce((sum, s) => sum + studentData[s.id].totalHours, 0);
                const avgHours = (totalHours / STUDENTS.length).toFixed(1);
                const studentsAtTarget = STUDENTS.filter(s => studentData[s.id].totalHours >= TARGET_TRAINING_HOURS).length;
                
                let totalReps = 0;
                let totalAssessments = 0;
                STUDENTS.forEach(student => {
                    Object.keys(studentData[student.id].skills).forEach(skillKey => {
                        const skill = studentData[student.id].skills[skillKey];
                        totalReps += (skill.repCount || 0);
                        totalAssessments += (skill.assessmentCount || 0);
                    });
                });

                html += `
                    <div class="report-section">
                        <h3>üìä Class Overview</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Training Hours</div>
                                <div class="stat-value">${totalHours}</div>
                                <div class="stat-label" style="font-size: 0.8em;">Class total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Average Hours</div>
                                <div class="stat-value">${avgHours}</div>
                                <div class="stat-label" style="font-size: 0.8em;">Per student (Target: 200)</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, ${studentsAtTarget > 0 ? '#28a745, #20c997' : '#dc3545, #e74c3c'});">
                                <div class="stat-label">At Target</div>
                                <div class="stat-value">${studentsAtTarget}/${STUDENTS.length}</div>
                                <div class="stat-label" style="font-size: 0.8em;">${((studentsAtTarget/STUDENTS.length)*100).toFixed(0)}% of class</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Practice Reps</div>
                                <div class="stat-value">${totalReps}</div>
                                <div class="stat-label" style="font-size: 0.8em;">Across all students</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Assessments</div>
                                <div class="stat-value">${totalAssessments}</div>
                                <div class="stat-label" style="font-size: 0.8em;">Formal evaluations</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Days to Competition</div>
                                <div class="stat-value">${Math.ceil((new Date('2026-04-13') - new Date()) / (1000 * 60 * 60 * 24))}</div>
                                <div class="stat-label" style="font-size: 0.8em;">April 13-15, 2026</div>
                            </div>
                        </div>
                    </div>
                `;

                // Hours Distribution
                html += `
                    <div class="report-section">
                        <h3>‚è∞ Training Hours Distribution</h3>
                        <table class="hours-log-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Student Name</th>
                                    <th>Hours</th>
                                    <th>% of Target</th>
                                    <th>Hours Needed</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                const sortedByHours = [...STUDENTS].sort((a, b) => 
                    studentData[b.id].totalHours - studentData[a.id].totalHours
                );

                sortedByHours.forEach((student, index) => {
                    const hours = studentData[student.id].totalHours;
                    const percent = ((hours / TARGET_TRAINING_HOURS) * 100).toFixed(1);
                    const needed = Math.max(0, TARGET_TRAINING_HOURS - hours);
                    
                    let status = 'Needs Acceleration';
                    let statusColor = '#dc3545';
                    if (hours >= TARGET_TRAINING_HOURS) {
                        status = 'Target Achieved';
                        statusColor = '#28a745';
                    } else if (hours >= 150) {
                        status = 'Near Target';
                        statusColor = '#ffc107';
                    } else if (hours >= 100) {
                        status = 'Good Progress';
                        statusColor = '#17a2b8';
                    }

                    html += `
                        <tr>
                            <td><strong>${index + 1}</strong></td>
                            <td>${student.name}</td>
                            <td><strong>${hours}</strong></td>
                            <td>${percent}%</td>
                            <td>${needed} hrs</td>
                            <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                // Skills Mastery by Zone
                html += `
                    <div class="report-section">
                        <h3>üéØ Skills Mastery by Zone</h3>
                `;

                Object.keys(SKILLS_DATA).forEach(zone => {
                    html += `<h4 style="color: #1e3c72; margin: 20px 0 15px 0;">${zone}</h4>`;
                    
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        
                        // Calculate class statistics for this skill
                        let totalPoints = 0;
                        let completedPoints = 0;
                        let studentsMastered = 0;
                        let totalRepsForSkill = 0;
                        
                        STUDENTS.forEach(student => {
                            const skillData = studentData[student.id].skills[skillKey];
                            totalPoints += skillData.completed.length;
                            completedPoints += skillData.completed.filter(Boolean).length;
                            totalRepsForSkill += (skillData.repCount || 0);
                            
                            const percent = (skillData.completed.filter(Boolean).length / skillData.completed.length) * 100;
                            if (percent === 100) studentsMastered++;
                        });
                        
                        const avgCompletion = ((completedPoints / totalPoints) * 100).toFixed(1);
                        
                        let skillColor = '#dc3545';
                        if (avgCompletion >= 90) skillColor = '#28a745';
                        else if (avgCompletion >= 70) skillColor = '#ffc107';
                        else if (avgCompletion >= 50) skillColor = '#17a2b8';

                        html += `
                            <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <strong>${skill.name}</strong>
                                    <span style="background: ${skillColor}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                        ${avgCompletion}% avg
                                    </span>
                                </div>
                                <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                                    <div style="background: ${skillColor}; height: 100%; width: ${avgCompletion}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                                    <span>üë• ${studentsMastered}/${STUDENTS.length} students mastered</span>
                                    <span>üí™ ${totalRepsForSkill} total practice reps</span>
                                    <span>üìä ${completedPoints}/${totalPoints} points completed</span>
                                </div>
                            </div>
                        `;
                    });
                });

                html += `</div>`;

                // Top Performers
                html += `
                    <div class="report-section">
                        <h3>üèÜ Top Performers</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                `;

                // Top 3 by hours
                const top3Hours = sortedByHours.slice(0, 3);
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px;">Most Training Hours</h4>
                `;
                top3Hours.forEach((student, i) => {
                    const medal = ['ü•á', 'ü•à', 'ü•â'][i];
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px;">
                            ${medal} <strong>${student.name.split(' ')[0]}</strong>: ${studentData[student.id].totalHours} hrs
                        </div>
                    `;
                });
                html += `</div>`;

                // Top 3 by skills completion
                const studentsByCompletion = [...STUDENTS].sort((a, b) => {
                    const aCompleted = Object.values(studentData[a.id].skills).reduce((sum, skill) => 
                        sum + skill.completed.filter(Boolean).length, 0);
                    const bCompleted = Object.values(studentData[b.id].skills).reduce((sum, skill) => 
                        sum + skill.completed.filter(Boolean).length, 0);
                    return bCompleted - aCompleted;
                });
                const top3Skills = studentsByCompletion.slice(0, 3);
                
                html += `
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px;">Highest Skills Mastery</h4>
                `;
                top3Skills.forEach((student, i) => {
                    const medal = ['ü•á', 'ü•à', 'ü•â'][i];
                    const completed = Object.values(studentData[student.id].skills).reduce((sum, skill) => 
                        sum + skill.completed.filter(Boolean).length, 0);
                    const total = Object.values(studentData[student.id].skills).reduce((sum, skill) => 
                        sum + skill.completed.length, 0);
                    const percent = ((completed / total) * 100).toFixed(1);
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px;">
                            ${medal} <strong>${student.name.split(' ')[0]}</strong>: ${percent}%
                        </div>
                    `;
                });
                html += `</div>`;

                html += `</div></div>`;

                // Recommendations
                html += `
                    <div class="report-section">
                        <h3>üìã Recommendations</h3>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 5px solid #ffc107;">
                `;

                const studentsNeedingHelp = STUDENTS.filter(s => studentData[s.id].totalHours < 100);
                if (studentsNeedingHelp.length > 0) {
                    html += `
                        <p style="margin-bottom: 15px;"><strong>‚ö†Ô∏è Priority Students (< 100 hours):</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                    `;
                    studentsNeedingHelp.forEach(student => {
                        const hours = studentData[student.id].totalHours;
                        const needed = TARGET_TRAINING_HOURS - hours;
                        const daysLeft = Math.ceil((new Date('2026-04-13') - new Date()) / (1000 * 60 * 60 * 24));
                        const perDay = (needed / daysLeft).toFixed(1);
                        html += `<li>${student.name}: ${hours} hrs (needs ${perDay} hrs/day)</li>`;
                    });
                    html += `</ul>`;
                }

                html += `
                        <p style="margin: 15px 0;"><strong>üí° Action Items:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Average ${((TARGET_TRAINING_HOURS - avgHours) / Math.ceil((new Date('2026-04-13') - new Date()) / (1000 * 60 * 60 * 24))).toFixed(1)} hours/day per student needed to reach target</li>
                            <li>Focus on skills with < 70% class average</li>
                            <li>Schedule extra practice sessions for priority students</li>
                            <li>Continue regular assessments to track improvement</li>
                        </ul>
                        </div>
                    </div>
                `;

                console.log('‚úÖ Group report HTML created');
                document.getElementById('reportContent').innerHTML = html;
                console.log('‚úÖ Group report displayed');
                showNotification('Group report generated successfully!', 'success');

            } catch (error) {
                console.error('‚ùå Group report error:', error);
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #dc3545;">Error Generating Group Report</h3>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
                showNotification('Error generating group report', 'error');
            }
        }

        function generateComparisonReport() {
            // Placeholder for future comparison report
            document.getElementById('reportContent').innerHTML = `
                <div class="report-header">
                    <h2>Student Comparison Report</h2>
                    <p>Compare multiple students side-by-side</p>
                </div>
                <div style="text-align: center; padding: 60px; color: #666;">
                    <h3>Coming Soon!</h3>
                    <p style="margin-top: 20px;">This feature will allow you to compare 2-5 students side by side.</p>
                </div>
            `;
        }

        function debugReport() {
            console.log('üîß DEBUG REPORT CLICKED');
            alert('Debug function loaded! Check console (F12) now.');
            
            const studentId = document.getElementById('reportStudent').value;
            console.log('Student ID:', studentId);
            console.log('STUDENTS array:', STUDENTS);
            console.log('studentData object:', studentData);
            
            if (!studentId) {
                alert('‚ùå Please select a student first!');
                return;
            }
            
            const student = STUDENTS.find(s => s.id == studentId);
            console.log('Found student:', student);
            
            if (student && studentData[studentId]) {
                alert(`‚úÖ All data found for ${student.name}! Try Generate Report now.`);
            } else {
                alert('‚ùå Student data missing!');
            }
        }

        function generateStudentReport() {
            try {
                console.log('üîç Generating student report...');
                
                const studentId = document.getElementById('reportStudent').value;
                console.log('Selected studentId:', studentId);
                
                if (!studentId) {
                    document.getElementById('reportContent').innerHTML = `
                        <p style="text-align: center; color: #666; font-size: 1.2em; padding: 40px;">
                            Select a student to generate report
                        </p>
                    `;
                    return;
                }

                const student = STUDENTS.find(s => s.id == studentId);
                if (!student) {
                    console.error('Student not found:', studentId);
                    document.getElementById('reportContent').innerHTML = `
                        <p style="text-align: center; color: #dc3545; font-size: 1.2em; padding: 40px;">
                            Error: Student not found
                        </p>
                    `;
                    return;
                }
                
                console.log('Found student:', student.name);
                const data = studentData[studentId];
                
                if (!data) {
                    console.error('Student data not found:', studentId);
                    document.getElementById('reportContent').innerHTML = `
                        <p style="text-align: center; color: #dc3545; font-size: 1.2em; padding: 40px;">
                            Error: Student data not found
                        </p>
                    `;
                    return;
                }

                let html = `
                    <div class="report-header">
                        <h2>Student Performance Report</h2>
                        <h3>${student.name}</h3>
                        <p>Generated: ${new Date().toLocaleDateString()}</p>
                        <p>Competition Date: April 13-15, 2026</p>
                    </div>
                `;

                console.log('‚úÖ Report header created');

                // Training Hours Summary
                const hoursProgress = ((data.totalHours / TARGET_TRAINING_HOURS) * 100).toFixed(0);
                const hoursRemaining = Math.max(0, TARGET_TRAINING_HOURS - data.totalHours);
                const daysLeft = Math.ceil((new Date('2026-04-13') - new Date()) / (1000 * 60 * 60 * 24));
                const hoursPerDay = daysLeft > 0 ? (hoursRemaining / daysLeft).toFixed(1) : 0;

                let hoursStatus = 'On Track';
                let hoursStatusColor = '#28a745';
                if (data.totalHours < TARGET_TRAINING_HOURS) {
                    if (hoursProgress < 50) {
                        hoursStatus = 'Needs Acceleration';
                        hoursStatusColor = '#dc3545';
                    } else if (hoursProgress < 75) {
                        hoursStatus = 'Moderate Progress';
                        hoursStatusColor = '#ffc107';
                    } else {
                        hoursStatus = 'Good Progress';
                        hoursStatusColor = '#17a2b8';
                    }
                } else {
                    hoursStatus = 'Target Achieved!';
                }

                html += `
                    <div class="report-section">
                        <h3>üìä Training Hours Summary</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Current Hours</div>
                                <div class="stat-value">${data.totalHours}</div>
                                <div class="stat-label" style="font-size: 0.8em;">${hoursProgress}% of target</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Target Hours</div>
                                <div class="stat-value">${TARGET_TRAINING_HOURS}</div>
                                <div class="stat-label" style="font-size: 0.8em;">${hoursRemaining} hrs remaining</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, ${hoursStatusColor}, ${hoursStatusColor}dd);">
                                <div class="stat-label">Status</div>
                                <div class="stat-value" style="font-size: 1.8em;">${hoursStatus}</div>
                                <div class="stat-label" style="font-size: 0.8em;">${hoursPerDay} hrs/day needed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Class Average</div>
                                <div class="stat-value">${(STUDENTS.reduce((sum, s) => sum + studentData[s.id].totalHours, 0) / STUDENTS.length).toFixed(1)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Rank in Class</div>
                                <div class="stat-value">${getRank(studentId)}/13</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="margin-bottom: 10px;"><strong>Progress to Target:</strong></div>
                            <div style="background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden;">
                                <div style="background: ${hoursStatusColor}; height: 100%; width: ${Math.min(hoursProgress, 100)}%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${hoursProgress}%
                                </div>
                            </div>
                            ${hoursRemaining > 0 ? `
                                <div style="margin-top: 10px; color: #666;">
                                    üìÖ With ${daysLeft} days remaining until competition, student needs approximately <strong>${hoursPerDay} hours per day</strong> to reach target.
                                </div>
                            ` : `
                                <div style="margin-top: 10px; color: #28a745; font-weight: bold;">
                                    üéâ Excellent! Target hours achieved. Continue practicing to maintain skills.
                                </div>
                            `}
                        </div>
                        <div style="margin-top: 20px;">
                            <canvas id="studentHoursChart"></canvas>
                        </div>
                    </div>
                `;

                console.log('‚úÖ Hours summary section created');

            // Skills Progress by Zone
            Object.keys(SKILLS_DATA).forEach(zone => {
                html += `<div class="report-section">`;
                html += `<h3>${zone} Skills Progress</h3>`;
                
                SKILLS_DATA[zone].forEach(skill => {
                    const skillKey = `${zone}_${skill.name}`;
                    const skillData = data.skills[skillKey];
                    const completedCount = skillData.completed.filter(Boolean).length;
                    const totalCount = skillData.completed.length;
                    const percent = ((completedCount / totalCount) * 100).toFixed(0);

                    let statusColor = '#dc3545';
                    let statusText = 'Needs Practice';
                    if (percent == 100) {
                        statusColor = '#28a745';
                        statusText = 'Mastered';
                    } else if (percent >= 70) {
                        statusColor = '#ffc107';
                        statusText = 'Proficient';
                    } else if (percent >= 40) {
                        statusColor = '#17a2b8';
                        statusText = 'Developing';
                    }

                    // Get assessment stats
                    const assessmentCount = skillData.assessmentCount || 0;
                    const bestScore = skillData.bestScore || 0;
                    const bestPercent = totalCount > 0 ? ((bestScore / totalCount) * 100).toFixed(0) : 0;
                    const repCount = skillData.repCount || 0;
                    
                    // Calculate improvement if history exists
                    let improvement = null;
                    let avgScore = percent;
                    if (skillData.assessmentHistory && skillData.assessmentHistory.length >= 2) {
                        const first = skillData.assessmentHistory[0].percentage;
                        const current = skillData.assessmentHistory[skillData.assessmentHistory.length - 1].percentage;
                        improvement = (current - first).toFixed(1);
                        avgScore = (skillData.assessmentHistory.reduce((sum, h) => sum + h.percentage, 0) / skillData.assessmentHistory.length).toFixed(1);
                    }

                    html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="font-size: 1.1em;">${skill.name}</strong>
                                <span style="background: ${statusColor}; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                                    ${statusText} (${percent}%)
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px; font-size: 0.9em;">
                                <div>üîÑ <strong>Assessed:</strong> ${assessmentCount}x</div>
                                <div style="color: #1e3c72;">üí™ <strong>Practice Reps:</strong> ${repCount}x</div>
                                <div>üèÜ <strong>Best:</strong> ${bestPercent}%</div>
                                ${improvement !== null ? `<div style="color: ${improvement >= 0 ? '#28a745' : '#dc3545'};">üìà <strong>Improvement:</strong> ${improvement > 0 ? '+' : ''}${improvement}%</div>` : ''}
                                ${assessmentCount > 0 ? `<div>üìä <strong>Avg:</strong> ${avgScore}%</div>` : ''}
                            </div>
                            
                            <div style="background: #e9ecef; height: 25px; border-radius: 12px; overflow: hidden;">
                                <div style="background: ${statusColor}; height: 100%; width: ${percent}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="margin-top: 10px; color: #666;">
                                Completed: ${completedCount}/${totalCount} assessment points
                                ${skillData.lastAssessed ? ` ‚Ä¢ Last assessed: ${new Date(skillData.lastAssessed).toLocaleDateString()}` : ''}
                            </div>
                            ${feedbackData[studentId]?.[skillKey] ? `
                                <div style="margin-top: 10px; padding: 10px; background: white; border-left: 4px solid #1e3c72; border-radius: 4px;">
                                    <strong>Trainer Feedback:</strong>
                                    <p style="margin: 5px 0 0 0;">${feedbackData[studentId][skillKey]}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `</div>`;
            });

            // Overall Summary
            const totalSkills = Object.keys(SKILLS_DATA).reduce((sum, zone) => sum + SKILLS_DATA[zone].length, 0);
            let masteredSkills = 0;
            Object.keys(data.skills).forEach(skillKey => {
                const skill = data.skills[skillKey];
                const percent = (skill.completed.filter(Boolean).length / skill.completed.length) * 100;
                if (percent === 100) masteredSkills++;
            });

            html += `
                <div class="report-section">
                    <h3>Overall Assessment</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <p style="font-size: 1.1em; margin-bottom: 15px;">
                            <strong>Skills Mastery:</strong> ${masteredSkills}/${totalSkills} skills fully mastered (${((masteredSkills/totalSkills)*100).toFixed(0)}%)
                        </p>
                        <p style="font-size: 1.1em; margin-bottom: 15px;">
                            <strong>Total Training Hours:</strong> ${data.totalHours} hours
                        </p>
                        <p style="font-size: 1.1em; margin-bottom: 15px;">
                            <strong>Last Assessment:</strong> ${new Date(data.lastUpdated).toLocaleDateString()}
                        </p>
                        ${getRecommendations(studentId)}
                    </div>
                </div>
            `;

            console.log('‚úÖ Setting report HTML...');
            document.getElementById('reportContent').innerHTML = html;
            console.log('‚úÖ Report HTML set successfully');

            // Render student-specific chart
            console.log('üé® Rendering student hours chart...');
            setTimeout(() => {
                try {
                    renderStudentHoursChart(studentId);
                    console.log('‚úÖ Chart rendered successfully');
                } catch (chartError) {
                    console.error('‚ùå Chart rendering error:', chartError);
                }
            }, 100);
            
            console.log('‚úÖ Report generation complete!');
            showNotification('Report generated successfully!', 'success');
            
            } catch (error) {
                console.error('‚ùå Report generation error:', error);
                document.getElementById('reportContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #dc3545;">Error Generating Report</h3>
                        <p style="color: #666; margin: 20px 0;">${error.message}</p>
                        <p style="color: #999; font-size: 0.9em;">Press F12 to see console for details</p>
                        <button class="btn btn-primary" onclick="generateStudentReport()" style="margin-top: 20px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
                showNotification('Error generating report - check console', 'error');
            }
        }

        function getRank(studentId) {
            const activeStudents = getActiveStudents();
            const sorted = activeStudents.map(s => ({
                id: s.id,
                hours: studentData[s.id].totalHours
            })).sort((a, b) => b.hours - a.hours);

            const rank = sorted.findIndex(s => s.id == studentId) + 1;
            return rank > 0 ? rank : 'N/A';
        }

        function getRecommendations(studentId) {
            const data = studentData[studentId];
            const recommendations = [];

            Object.keys(SKILLS_DATA).forEach(zone => {
                SKILLS_DATA[zone].forEach(skill => {
                    const skillKey = `${zone}_${skill.name}`;
                    const skillData = data.skills[skillKey];
                    const percent = (skillData.completed.filter(Boolean).length / skillData.completed.length) * 100;

                    if (percent < 70) {
                        recommendations.push(`Focus on <strong>${skill.name}</strong> in ${zone} (${percent.toFixed(0)}% complete)`);
                    }
                });
            });

            if (recommendations.length === 0) {
                return '<p style="color: #28a745; font-weight: bold;">üéâ Excellent progress! All skills are well-developed. Continue practicing to maintain mastery.</p>';
            }

            return `
                <div style="margin-top: 15px;">
                    <strong>Recommendations for Improvement:</strong>
                    <ul style="margin-top: 10px;">
                        ${recommendations.slice(0, 5).map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // ==================== CHARTS ====================
        function renderOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            const activeStudents = getActiveStudents();
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: activeStudents.map(s => s.name.split(' ')[0]),
                    datasets: [
                        {
                            label: 'Current Hours',
                            data: activeStudents.map(s => studentData[s.id].totalHours),
                            backgroundColor: activeStudents.map(s => {
                                const hours = studentData[s.id].totalHours;
                                if (hours >= TARGET_TRAINING_HOURS) return 'rgba(40, 167, 69, 0.8)'; // Green
                                if (hours >= 150) return 'rgba(255, 193, 7, 0.8)'; // Yellow
                                if (hours >= 100) return 'rgba(23, 162, 184, 0.8)'; // Blue
                                return 'rgba(220, 53, 69, 0.8)'; // Red
                            }),
                            borderColor: activeStudents.map(s => {
                                const hours = studentData[s.id].totalHours;
                                if (hours >= TARGET_TRAINING_HOURS) return 'rgba(40, 167, 69, 1)';
                                if (hours >= 150) return 'rgba(255, 193, 7, 1)';
                                if (hours >= 100) return 'rgba(23, 162, 184, 1)';
                                return 'rgba(220, 53, 69, 1)';
                            }),
                            borderWidth: 2
                        },
                        {
                            label: 'Target (200 hrs)',
                            data: activeStudents.map(() => TARGET_TRAINING_HOURS),
                            type: 'line',
                            borderColor: 'rgba(220, 53, 69, 0.8)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(TARGET_TRAINING_HOURS + 20, Math.max(...STUDENTS.map(s => studentData[s.id].totalHours)) + 20),
                            title: {
                                display: true,
                                text: 'Hours'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === TARGET_TRAINING_HOURS) {
                                        return value + ' (TARGET)';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `Training Hours Progress (Target: ${TARGET_TRAINING_HOURS} hours)`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Current Hours') {
                                        const hours = context.parsed.y;
                                        const percent = ((hours / TARGET_TRAINING_HOURS) * 100).toFixed(1);
                                        const remaining = TARGET_TRAINING_HOURS - hours;
                                        return [
                                            `${context.dataset.label}: ${hours} hrs`,
                                            `Progress: ${percent}% of target`,
                                            `Remaining: ${remaining > 0 ? remaining : 0} hrs`
                                        ];
                                    }
                                    return context.dataset.label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderHoursChart() {
            const ctx = document.getElementById('hoursChart');
            if (!ctx) return;

            new Chart(ctx.getContext('2d'), {
                type: 'horizontalBar',
                data: {
                    labels: STUDENTS.map(s => s.name.split(' ')[0]),
                    datasets: [
                        {
                            label: 'Current Hours',
                            data: STUDENTS.map(s => studentData[s.id].totalHours),
                            backgroundColor: STUDENTS.map(s => {
                                const hours = studentData[s.id].totalHours;
                                if (hours >= TARGET_TRAINING_HOURS) return 'rgba(40, 167, 69, 0.8)';
                                if (hours >= 150) return 'rgba(255, 193, 7, 0.8)';
                                if (hours >= 100) return 'rgba(23, 162, 184, 0.8)';
                                return 'rgba(220, 53, 69, 0.8)';
                            })
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: TARGET_TRAINING_HOURS + 20,
                            title: {
                                display: true,
                                text: 'Hours'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === TARGET_TRAINING_HOURS) {
                                        return value + ' ‚òÖ';
                                    }
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: `Student Hours vs Target (${TARGET_TRAINING_HOURS} hours)`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        annotation: {
                            annotations: {
                                targetLine: {
                                    type: 'line',
                                    xMin: TARGET_TRAINING_HOURS,
                                    xMax: TARGET_TRAINING_HOURS,
                                    borderColor: 'rgba(220, 53, 69, 0.8)',
                                    borderWidth: 3,
                                    borderDash: [10, 5],
                                    label: {
                                        display: true,
                                        content: 'Target',
                                        position: 'end'
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const hours = context.parsed.x;
                                    const percent = ((hours / TARGET_TRAINING_HOURS) * 100).toFixed(1);
                                    const remaining = Math.max(0, TARGET_TRAINING_HOURS - hours);
                                    return [
                                        `Hours: ${hours}`,
                                        `Progress: ${percent}%`,
                                        `To target: ${remaining} hrs`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderStudentHoursChart(studentId) {
            const ctx = document.getElementById('studentHoursChart');
            if (!ctx) return;

            const student = STUDENTS.find(s => s.id == studentId);
            const avgHours = STUDENTS.reduce((sum, s) => sum + studentData[s.id].totalHours, 0) / STUDENTS.length;

            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['This Student', 'Class Average', 'Target'],
                    datasets: [{
                        label: 'Training Hours',
                        data: [studentData[studentId].totalHours, avgHours, TARGET_TRAINING_HOURS],
                        backgroundColor: [
                            studentData[studentId].totalHours >= TARGET_TRAINING_HOURS ? 'rgba(40, 167, 69, 0.8)' : 'rgba(30, 60, 114, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderColor: [
                            studentData[studentId].totalHours >= TARGET_TRAINING_HOURS ? 'rgba(40, 167, 69, 1)' : 'rgba(30, 60, 114, 1)',
                            'rgba(118, 75, 162, 1)',
                            'rgba(255, 193, 7, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(TARGET_TRAINING_HOURS + 20, studentData[studentId].totalHours + 20)
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Training Hours Comparison (Target: ${TARGET_TRAINING_HOURS} hours)`
                        }
                    }
                }
            });
        }

        function renderAllAnalytics() {
            populateAnalyticsStudentSelect();
            renderZoneProgressChart();
            renderTopPerformersChart();
            renderHoursDistributionChart();
            renderProgressTimelineChart();
        }

        function populateAnalyticsStudentSelect() {
            const select = document.getElementById('analyticsStudent');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select Student --</option>';
            STUDENTS.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }

        function showStudentProgressAnalytics() {
            const studentId = document.getElementById('analyticsStudent').value;
            if (!studentId) {
                document.getElementById('individualProgressSection').style.display = 'none';
                return;
            }

            const student = STUDENTS.find(s => s.id == studentId);
            const data = studentData[studentId];

            // Calculate overall statistics
            let totalAssessments = 0;
            let skillsWithProgress = 0;
            let totalImprovement = 0;
            let improvementCount = 0;
            const skillsByZone = {};

            Object.keys(SKILLS_DATA).forEach(zone => {
                skillsByZone[zone] = {
                    assessed: 0,
                    total: SKILLS_DATA[zone].length,
                    avgProgress: 0
                };
            });

            Object.keys(data.skills).forEach(skillKey => {
                const skill = data.skills[skillKey];
                totalAssessments += (skill.assessmentCount || 0);
                
                if (skill.assessmentCount > 0) {
                    skillsWithProgress++;
                    skillsByZone[skill.zone].assessed++;
                }

                const progress = (skill.completed.filter(Boolean).length / skill.completed.length) * 100;
                skillsByZone[skill.zone].avgProgress += progress;

                if (skill.assessmentHistory && skill.assessmentHistory.length >= 2) {
                    const first = skill.assessmentHistory[0].percentage;
                    const last = skill.assessmentHistory[skill.assessmentHistory.length - 1].percentage;
                    totalImprovement += (last - first);
                    improvementCount++;
                }
            });

            Object.keys(skillsByZone).forEach(zone => {
                skillsByZone[zone].avgProgress /= skillsByZone[zone].total;
            });

            const avgImprovement = improvementCount > 0 ? (totalImprovement / improvementCount).toFixed(1) : 0;
            const totalSkills = Object.keys(SKILLS_DATA).reduce((sum, z) => sum + SKILLS_DATA[z].length, 0);

            // Display stats
            document.getElementById('individualProgressStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">${student.name.split(' ')[0]}'s Total Assessments</div>
                    <div class="stat-value">${totalAssessments}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Skills Practiced</div>
                    <div class="stat-value">${skillsWithProgress}/${totalSkills}</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, ${avgImprovement >= 0 ? '#28a745, #20c997' : '#dc3545, #e74c3c'});">
                    <div class="stat-label">Avg Improvement</div>
                    <div class="stat-value">${avgImprovement > 0 ? '+' : ''}${avgImprovement}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Red Zone Progress</div>
                    <div class="stat-value">${skillsByZone['Red Zone'].avgProgress.toFixed(0)}%</div>
                    <div class="stat-label" style="font-size: 0.8em;">${skillsByZone['Red Zone'].assessed}/${skillsByZone['Red Zone'].total} assessed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Yellow Zone Progress</div>
                    <div class="stat-value">${skillsByZone['Yellow Zone'].avgProgress.toFixed(0)}%</div>
                    <div class="stat-label" style="font-size: 0.8em;">${skillsByZone['Yellow Zone'].assessed}/${skillsByZone['Yellow Zone'].total} assessed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Green Zone Progress</div>
                    <div class="stat-value">${skillsByZone['Green Zone'].avgProgress.toFixed(0)}%</div>
                    <div class="stat-label" style="font-size: 0.8em;">${skillsByZone['Green Zone'].assessed}/${skillsByZone['Green Zone'].total} assessed</div>
                </div>
            `;

            // Create chart showing assessment count per skill
            const skillNames = [];
            const assessmentCounts = [];
            const progressPercentages = [];

            Object.keys(SKILLS_DATA).forEach(zone => {
                SKILLS_DATA[zone].forEach(skill => {
                    const skillKey = `${zone}_${skill.name}`;
                    const skillData = data.skills[skillKey];
                    skillNames.push(skill.name.substring(0, 25) + '...');
                    assessmentCounts.push(skillData.assessmentCount || 0);
                    const progress = (skillData.completed.filter(Boolean).length / skillData.completed.length) * 100;
                    progressPercentages.push(progress);
                });
            });

            const ctx = document.getElementById('individualSkillsChart');
            if (ctx) {
                const existingChart = Chart.getChart(ctx);
                if (existingChart) existingChart.destroy();

                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: skillNames,
                        datasets: [
                            {
                                label: 'Assessment Count',
                                data: assessmentCounts,
                                backgroundColor: 'rgba(30, 60, 114, 0.8)',
                                yAxisID: 'y1'
                            },
                            {
                                label: 'Current Progress %',
                                data: progressPercentages,
                                backgroundColor: 'rgba(40, 167, 69, 0.6)',
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y1: {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Number of Assessments'
                                },
                                beginAtZero: true
                            },
                            y2: {
                                type: 'linear',
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Progress %'
                                },
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }

            document.getElementById('individualProgressSection').style.display = 'block';
        }

        function renderZoneProgressChart() {
            const ctx = document.getElementById('zoneProgressChart');
            if (!ctx) return;

            const zones = Object.keys(SKILLS_DATA);
            const data = zones.map(zone => {
                let total = 0;
                let completed = 0;
                STUDENTS.forEach(student => {
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        const skillData = studentData[student.id].skills[skillKey];
                        total += skillData.completed.length;
                        completed += skillData.completed.filter(Boolean).length;
                    });
                });
                return total > 0 ? (completed / total) * 100 : 0;
            });

            new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: zones,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderTopPerformersChart() {
            const ctx = document.getElementById('topPerformersChart');
            if (!ctx) return;

            const studentScores = STUDENTS.map(student => {
                let totalItems = 0;
                let completedItems = 0;
                Object.keys(studentData[student.id].skills).forEach(skillKey => {
                    const skill = studentData[student.id].skills[skillKey];
                    totalItems += skill.completed.length;
                    completedItems += skill.completed.filter(Boolean).length;
                });
                return {
                    name: student.name.split(' ')[0],
                    score: totalItems > 0 ? (completedItems / totalItems) * 100 : 0
                };
            }).sort((a, b) => b.score - a.score).slice(0, 5);

            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: studentScores.map(s => s.name),
                    datasets: [{
                        label: 'Skills Completion %',
                        data: studentScores.map(s => s.score),
                        backgroundColor: 'rgba(30, 60, 114, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderHoursDistributionChart() {
            const ctx = document.getElementById('hoursDistributionChart');
            if (!ctx) return;

            const ranges = ['0-100', '101-150', '151-199', '200+'];
            const distribution = [0, 0, 0, 0];

            STUDENTS.forEach(student => {
                const hours = studentData[student.id].totalHours;
                if (hours <= 100) distribution[0]++;
                else if (hours <= 150) distribution[1]++;
                else if (hours < 200) distribution[2]++;
                else distribution[3]++;
            });

            new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ranges.map((r, i) => `${r} hrs (${distribution[i]})`),
                    datasets: [{
                        data: distribution,
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(40, 167, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Students by Training Hours Range'
                        }
                    }
                }
            });
        }

        function renderProgressTimelineChart() {
            const ctx = document.getElementById('progressTimelineChart');
            if (!ctx) return;

            // Simulate weekly progress (in real app, track actual progress over time)
            const weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Current'];
            const avgProgress = weeks.map((w, i) => {
                let total = 0;
                STUDENTS.forEach(student => {
                    Object.keys(studentData[student.id].skills).forEach(skillKey => {
                        const skill = studentData[student.id].skills[skillKey];
                        total += skill.completed.filter(Boolean).length / skill.completed.length;
                    });
                });
                return (total / STUDENTS.length / Object.keys(SKILLS_DATA).reduce((sum, z) => sum + SKILLS_DATA[z].length, 0)) * 100 * ((i + 1) / weeks.length);
            });

            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Average Progress %',
                        data: avgProgress,
                        borderColor: 'rgba(30, 60, 114, 1)',
                        backgroundColor: 'rgba(30, 60, 114, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // ==================== DATA MANAGEMENT ====================
        function saveAllProgress() {
            saveToLocalStorage();
            showNotification('All progress saved successfully!', 'success');
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('emiratesSkillsData', JSON.stringify({
                    studentData: studentData,
                    trainingHoursLog: trainingHoursLog,
                    feedbackData: feedbackData,
                    lastSaved: new Date().toISOString()
                }));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('emiratesSkillsData');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.studentData) {
                        studentData = data.studentData;
                        console.log('‚úÖ Student data loaded from localStorage');
                    }
                    if (data.trainingHoursLog) {
                        trainingHoursLog = data.trainingHoursLog;
                        console.log('‚úÖ Training hours log loaded');
                    }
                    if (data.feedbackData) {
                        feedbackData = data.feedbackData;
                        console.log('‚úÖ Feedback data loaded');
                    }
                    
                    // Don't render here - let initializeApp handle it
                    // showNotification('Previous data loaded successfully!', 'info');
                }
            } catch (e) {
                console.error('‚ùå Error loading from localStorage:', e);
            }
        }

        function saveAllData() {
            saveToLocalStorage();
            showNotification('All data saved to browser storage!', 'success');
        }

        function exportBackup() {
            const backup = {
                studentData: studentData,
                trainingHoursLog: trainingHoursLog,
                feedbackData: feedbackData,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `emirates-skills-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Backup downloaded!', 'success');
        }

        function loadBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (backup.studentData) studentData = backup.studentData;
                        if (backup.trainingHoursLog) trainingHoursLog = backup.trainingHoursLog;
                        if (backup.feedbackData) feedbackData = backup.feedbackData;
                        
                        saveToLocalStorage();
                        renderStudentRoster();
                        renderHoursLog();
                        showNotification('Backup loaded successfully!', 'success');
                        location.reload();
                    } catch (error) {
                        showNotification('Error loading backup file!', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            // Student Summary Sheet
            const summaryData = STUDENTS.map(student => {
                const data = studentData[student.id];
                let masteredSkills = 0;
                let totalSkillPoints = 0;
                let completedSkillPoints = 0;

                Object.keys(data.skills).forEach(skillKey => {
                    const skill = data.skills[skillKey];
                    totalSkillPoints += skill.completed.length;
                    completedSkillPoints += skill.completed.filter(Boolean).length;
                    if (skill.completed.every(Boolean)) masteredSkills++;
                });

                return {
                    'Student Name': student.name,
                    'Total Hours': data.totalHours,
                    'Skills Mastered': masteredSkills,
                    'Total Skills': Object.keys(SKILLS_DATA).reduce((sum, z) => sum + SKILLS_DATA[z].length, 0),
                    'Completion %': ((completedSkillPoints / totalSkillPoints) * 100).toFixed(1),
                    'Last Updated': new Date(data.lastUpdated).toLocaleDateString()
                };
            });

            const ws1 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Student Summary');

            // Training Hours Sheet
            const hoursData = trainingHoursLog.map(entry => ({
                'Date': entry.date,
                'Student': entry.studentName,
                'Hours': entry.hours,
                'Notes': entry.notes || ''
            }));

            const ws2 = XLSX.utils.json_to_sheet(hoursData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Training Hours Log');

            // Skills Detail Sheet
            const skillsDetail = [];
            STUDENTS.forEach(student => {
                const data = studentData[student.id];
                Object.keys(SKILLS_DATA).forEach(zone => {
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        const skillData = data.skills[skillKey];
                        const completed = skillData.completed.filter(Boolean).length;
                        const total = skillData.completed.length;
                        
                        skillsDetail.push({
                            'Student': student.name,
                            'Zone': zone,
                            'Skill': skill.name,
                            'Completed': completed,
                            'Total': total,
                            'Percentage': ((completed / total) * 100).toFixed(0) + '%',
                            'Status': completed === total ? 'Mastered' : completed > total * 0.7 ? 'Proficient' : 'In Progress'
                        });
                    });
                });
            });

            const ws3 = XLSX.utils.json_to_sheet(skillsDetail);
            XLSX.utils.book_append_sheet(wb, ws3, 'Skills Detail');

            XLSX.writeFile(wb, `emirates-skills-report-${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Excel report exported!', 'success');
        }

        function exportStudentReportExcel() {
            console.log('üìä Exporting student report to Excel...');
            
            const studentId = document.getElementById('reportStudent').value;
            if (!studentId) {
                alert('Please select a student first!');
                return;
            }

            const student = STUDENTS.find(s => s.id == studentId);
            const data = studentData[studentId];
            
            if (!student || !data) {
                alert('Student data not found!');
                return;
            }

            showLoading('Generating Excel report...');

            try {
                const wb = XLSX.utils.book_new();
                
                // Helper function to create visual progress bar
                const createProgressBar = (percent) => {
                    const filled = Math.round(percent / 10);
                    const empty = 10 - filled;
                    return '‚ñà'.repeat(filled) + '‚ñë'.repeat(empty) + ` ${percent}%`;
                };
                
                // Sheet 1: Summary with visuals
                const summaryData = [
                    [student.name.toUpperCase()],
                    [`Performance Report - Generated ${new Date().toLocaleDateString()}`],
                    ['Competition Date: April 13-15, 2026'],
                    [],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['TRAINING HOURS SUMMARY'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    []
                ];
                
                const hoursProgress = ((data.totalHours / TARGET_TRAINING_HOURS) * 100).toFixed(1);
                const hoursRemaining = Math.max(0, TARGET_TRAINING_HOURS - data.totalHours);
                
                summaryData.push(['Current Hours:', data.totalHours, createProgressBar(parseFloat(hoursProgress))]);
                summaryData.push(['Target Hours:', TARGET_TRAINING_HOURS]);
                summaryData.push(['Hours Remaining:', hoursRemaining]);
                summaryData.push(['Progress to Target:', hoursProgress + '%', createProgressBar(parseFloat(hoursProgress))]);
                summaryData.push(['Class Average:', (STUDENTS.reduce((sum, s) => sum + studentData[s.id].totalHours, 0) / STUDENTS.length).toFixed(1)]);
                summaryData.push(['Class Rank:', `${getRank(studentId)} of 13`]);
                
                let status = 'Needs Acceleration üî¥';
                if (data.totalHours >= TARGET_TRAINING_HOURS) status = 'Target Achieved! üü¢';
                else if (hoursProgress >= 75) status = 'Good Progress üîµ';
                else if (hoursProgress >= 50) status = 'Moderate Progress üü°';
                summaryData.push(['Status:', status]);
                
                summaryData.push([]);
                summaryData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                summaryData.push(['SKILLS OVERVIEW BY ZONE']);
                summaryData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
                summaryData.push([]);
                
                // Calculate zone progress
                Object.keys(SKILLS_DATA).forEach(zone => {
                    let zoneTotal = 0;
                    let zoneCompleted = 0;
                    let zoneReps = 0;
                    
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        const skillData = data.skills[skillKey];
                        zoneTotal += skillData.completed.length;
                        zoneCompleted += skillData.completed.filter(Boolean).length;
                        zoneReps += (skillData.repCount || 0);
                    });
                    
                    const zonePercent = zoneTotal > 0 ? ((zoneCompleted / zoneTotal) * 100).toFixed(1) : 0;
                    summaryData.push([zone + ':', `${zoneCompleted}/${zoneTotal} points`, createProgressBar(parseFloat(zonePercent)), `${zoneReps} reps`]);
                });
                
                // Overall progress
                let totalPoints = 0;
                let completedPoints = 0;
                let totalReps = 0;
                let masteredSkills = 0;
                
                Object.keys(data.skills).forEach(skillKey => {
                    const skill = data.skills[skillKey];
                    totalPoints += skill.completed.length;
                    completedPoints += skill.completed.filter(Boolean).length;
                    totalReps += (skill.repCount || 0);
                    if (skill.completed.filter(Boolean).length === skill.completed.length) masteredSkills++;
                });
                
                const overallPercent = ((completedPoints / totalPoints) * 100).toFixed(1);
                summaryData.push([]);
                summaryData.push(['OVERALL PROGRESS:', `${completedPoints}/${totalPoints}`, createProgressBar(parseFloat(overallPercent))]);
                summaryData.push(['Skills Mastered:', `${masteredSkills}/11`]);
                summaryData.push(['Total Practice Reps:', totalReps]);
                
                const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
                ws1['!cols'] = [{wch: 25}, {wch: 15}, {wch: 35}, {wch: 15}];
                XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

                // Sheet 2: Skills Progress with visual bars
                const skillsData = [
                    ['SKILLS ASSESSMENT DETAILS'],
                    [],
                    ['Zone', 'Skill Name', 'Completed', 'Total', 'Progress', 'Visual Progress', 'Assessments', 'Reps', 'Best', 'Status']
                ];
                
                Object.keys(SKILLS_DATA).forEach(zone => {
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        const skillData = data.skills[skillKey];
                        const completed = skillData.completed.filter(Boolean).length;
                        const total = skillData.completed.length;
                        const percent = ((completed / total) * 100).toFixed(0);
                        
                        let status = 'Needs Practice';
                        let statusIcon = '‚óã';
                        if (percent == 100) { status = 'Mastered'; statusIcon = '‚úì'; }
                        else if (percent >= 70) { status = 'Proficient'; statusIcon = '‚óê'; }
                        else if (percent >= 40) { status = 'Developing'; statusIcon = '‚óî'; }
                        
                        skillsData.push([
                            zone,
                            skill.name,
                            completed,
                            total,
                            percent + '%',
                            createProgressBar(parseInt(percent)),
                            skillData.assessmentCount || 0,
                            skillData.repCount || 0,
                            `${skillData.bestScore || 0}/${total}`,
                            statusIcon + ' ' + status
                        ]);
                    });
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(skillsData);
                ws2['!cols'] = [{wch: 12}, {wch: 35}, {wch: 10}, {wch: 8}, {wch: 10}, {wch: 35}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 18}];
                XLSX.utils.book_append_sheet(wb, ws2, 'Skills Progress');

                // Sheet 3: Detailed Assessment Checklist
                const detailData = [
                    ['DETAILED ASSESSMENT CHECKLIST'],
                    ['Use this to track individual assessment points'],
                    [],
                    ['Skill', 'Assessment Point', 'Status', 'Notes']
                ];
                
                Object.keys(SKILLS_DATA).forEach(zone => {
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        const skillData = data.skills[skillKey];
                        
                        detailData.push([]);
                        detailData.push([`${zone} - ${skill.name}`, '', '', '']);
                        detailData.push(['‚îÄ'.repeat(40), '‚îÄ'.repeat(60), '‚îÄ'.repeat(15), '‚îÄ'.repeat(30)]);
                        
                        skill.items.forEach((item, index) => {
                            detailData.push([
                                '',
                                item,
                                skillData.completed[index] ? '‚úì Complete' : '‚óã Incomplete',
                                ''
                            ]);
                        });
                    });
                });
                
                const ws3 = XLSX.utils.aoa_to_sheet(detailData);
                ws3['!cols'] = [{wch: 40}, {wch: 60}, {wch: 15}, {wch: 30}];
                XLSX.utils.book_append_sheet(wb, ws3, 'Detailed Checklist');

                // Sheet 4: Feedback & Recommendations
                const feedbackRows = [
                    ['TRAINER FEEDBACK & RECOMMENDATIONS'],
                    [],
                    ['Skill', 'Trainer Feedback', 'Date']
                ];
                
                let hasFeedback = false;
                Object.keys(SKILLS_DATA).forEach(zone => {
                    SKILLS_DATA[zone].forEach(skill => {
                        const skillKey = `${zone}_${skill.name}`;
                        const feedback = feedbackData[studentId]?.[skillKey];
                        const skillData = data.skills[skillKey];
                        
                        if (feedback) {
                            hasFeedback = true;
                            feedbackRows.push([
                                skill.name,
                                feedback,
                                skillData.lastAssessed ? new Date(skillData.lastAssessed).toLocaleDateString() : ''
                            ]);
                        }
                    });
                });
                
                if (!hasFeedback) {
                    feedbackRows.push(['(No feedback recorded yet)', '', '']);
                }
                
                const ws4 = XLSX.utils.aoa_to_sheet(feedbackRows);
                ws4['!cols'] = [{wch: 35}, {wch: 80}, {wch: 15}];
                XLSX.utils.book_append_sheet(wb, ws4, 'Feedback');

                // Generate filename
                const filename = `${student.name.replace(/[^a-zA-Z0-9]/g, '-')}-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                console.log('‚úÖ Excel report with visuals exported:', filename);
                showNotification('‚úÖ Excel report with progress bars downloaded!', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Excel export error:', error);
                alert('Error exporting to Excel: ' + error.message);
                showNotification('‚ùå Excel export failed', 'error');
            }
        }

        function exportStudentReportHTML() {
            const studentId = document.getElementById('reportStudent').value;
            if (!studentId) {
                alert('Please select a student first!');
                return;
            }

            const student = STUDENTS.find(s => s.id == studentId);
            const element = document.getElementById('reportContent');
            
            if (!element || element.innerHTML.length < 100) {
                alert('Please generate a report first!');
                return;
            }

            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${student.name} - Performance Report</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .report-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .report-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .report-section h3 {
            color: #1e3c72;
            border-bottom: 3px solid #1e3c72;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 10px;
            border-radius: 10px;
            min-width: 150px;
            text-align: center;
        }
        @media print {
            body { background: white; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    ${element.innerHTML}
    <div class="no-print" style="margin-top: 30px; text-align: center; padding: 20px;">
        <p style="color: #666;">This report was generated on ${new Date().toLocaleString()}</p>
        <button onclick="window.print()" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; cursor: pointer; border-radius: 5px;">
            üñ®Ô∏è Print This Report
        </button>
    </div>
</body>
</html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${student.name.replace(/[^a-zA-Z0-9]/g, '-')}-Report-${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('‚úÖ HTML report downloaded!', 'success');
        }

        function exportAllStudentsExcel() {
            const activeStudents = getActiveStudents();
            showLoading(`Generating reports for ${activeStudents.length} students...`);
            
            setTimeout(() => {
                try {
                const wb = XLSX.utils.book_new();
                
                // Class Overview Sheet with detailed stats
                const overviewData = [
                    ['Emirates Skills National Competition 2026 - Class Report'],
                    [`Generated: ${new Date().toLocaleDateString()}`],
                    ['Competition Date: April 13-15, 2026'],
                    [`Active Students: ${activeStudents.length}`],
                    [],
                    ['STUDENT', 'TOTAL HOURS', 'TARGET', 'HOURS %', 'HOURS LEFT', 'RED ZONE %', 'YELLOW ZONE %', 'GREEN ZONE %', 'OVERALL %', 'SKILLS MASTERED', 'TOTAL REPS', 'RANK']
                ];
                
                const sortedStudents = [...activeStudents].sort((a, b) => studentData[b.id].totalHours - studentData[a.id].totalHours);
                
                sortedStudents.forEach((student, index) => {
                    const data = studentData[student.id];
                    
                    // Calculate zone percentages
                    const zoneStats = {};
                    Object.keys(SKILLS_DATA).forEach(zone => {
                        let zoneTotal = 0;
                        let zoneCompleted = 0;
                        SKILLS_DATA[zone].forEach(skill => {
                            const skillKey = `${zone}_${skill.name}`;
                            const skillData = data.skills[skillKey];
                            zoneTotal += skillData.completed.length;
                            zoneCompleted += skillData.completed.filter(Boolean).length;
                        });
                        zoneStats[zone] = zoneTotal > 0 ? ((zoneCompleted / zoneTotal) * 100).toFixed(1) : 0;
                    });
                    
                    // Calculate overall
                    let totalPoints = 0;
                    let completedPoints = 0;
                    let masteredSkills = 0;
                    let totalReps = 0;
                    
                    Object.keys(data.skills).forEach(skillKey => {
                        const skill = data.skills[skillKey];
                        const completed = skill.completed.filter(Boolean).length;
                        const total = skill.completed.length;
                        totalPoints += total;
                        completedPoints += completed;
                        if (completed === total && total > 0) masteredSkills++;
                        totalReps += (skill.repCount || 0);
                    });
                    
                    const hoursProgress = ((data.totalHours / TARGET_TRAINING_HOURS) * 100).toFixed(1);
                    const overallProgress = ((completedPoints / totalPoints) * 100).toFixed(1);
                    
                    overviewData.push([
                        student.name,
                        data.totalHours,
                        TARGET_TRAINING_HOURS,
                        hoursProgress + '%',
                        Math.max(0, TARGET_TRAINING_HOURS - data.totalHours),
                        zoneStats['Red Zone'] + '%',
                        zoneStats['Yellow Zone'] + '%',
                        zoneStats['Green Zone'] + '%',
                        overallProgress + '%',
                        `${masteredSkills}/11`,
                        totalReps,
                        index + 1
                    ]);
                });
                
                // Add summary statistics at bottom
                const avgHours = activeStudents.length > 0 ? (activeStudents.reduce((sum, s) => sum + studentData[s.id].totalHours, 0) / activeStudents.length).toFixed(1) : 0;
                const studentsAtTarget = activeStudents.filter(s => studentData[s.id].totalHours >= TARGET_TRAINING_HOURS).length;
                
                overviewData.push([]);
                overviewData.push(['CLASS STATISTICS']);
                overviewData.push(['Active Students:', activeStudents.length]);
                overviewData.push(['Average Hours:', avgHours]);
                overviewData.push(['Students at Target (200+ hrs):', studentsAtTarget]);
                overviewData.push(['Students Above 100 hrs:', activeStudents.filter(s => studentData[s.id].totalHours >= 100).length]);
                overviewData.push(['Days Until Competition:', Math.ceil((new Date('2026-04-13') - new Date()) / (1000 * 60 * 60 * 24))]);
                
                const ws1 = XLSX.utils.aoa_to_sheet(overviewData);
                
                // Set column widths
                ws1['!cols'] = [
                    {wch: 35}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 12}, 
                    {wch: 12}, {wch: 14}, {wch: 14}, {wch: 12}, {wch: 16}, {wch: 12}, {wch: 8}
                ];
                
                XLSX.utils.book_append_sheet(wb, ws1, 'Class Overview');

                // Skills Comparison Sheet - All students side by side
                const comparisonData = [
                    ['SKILLS COMPARISON - ALL STUDENTS'],
                    [],
                    ['Zone', 'Skill']
                ];
                
                // Add student names as headers
                activeStudents.forEach(student => {
                    comparisonData[2].push(student.name.split(' ')[0]);
                });
                
                // Add each skill with all student percentages
                Object.keys(SKILLS_DATA).forEach(zone => {
                    SKILLS_DATA[zone].forEach(skill => {
                        const row = [zone, skill.name];
                        activeStudents.forEach(student => {
                            const skillKey = `${zone}_${skill.name}`;
                            const skillData = studentData[student.id].skills[skillKey];
                            const completed = skillData.completed.filter(Boolean).length;
                            const total = skillData.completed.length;
                            const percent = ((completed / total) * 100).toFixed(0);
                            row.push(percent + '%');
                        });
                        comparisonData.push(row);
                    });
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(comparisonData);
                ws2['!cols'] = [{wch: 15}, {wch: 30}, ...Array(activeStudents.length).fill({wch: 12})];
                XLSX.utils.book_append_sheet(wb, ws2, 'Skills Comparison');

                // Individual detailed sheets for each active student
                activeStudents.forEach(student => {
                    const data = studentData[student.id];
                    const sheetData = [
                        [student.name.toUpperCase()],
                        [`Report Date: ${new Date().toLocaleDateString()}`],
                        [],
                        ['TRAINING HOURS SUMMARY'],
                        ['Current Hours:', data.totalHours],
                        ['Target Hours:', TARGET_TRAINING_HOURS],
                        ['Progress:', `${((data.totalHours/TARGET_TRAINING_HOURS)*100).toFixed(1)}%`],
                        ['Hours Remaining:', Math.max(0, TARGET_TRAINING_HOURS - data.totalHours)],
                        ['Class Rank:', `${getRank(student.id)}/13`],
                        [],
                        ['SKILLS ASSESSMENT'],
                        ['Zone', 'Skill Name', 'Completed', 'Total', 'Progress %', 'Assessments', 'Practice Reps', 'Best Score', 'Status']
                    ];
                    
                    Object.keys(SKILLS_DATA).forEach(zone => {
                        SKILLS_DATA[zone].forEach(skill => {
                            const skillKey = `${zone}_${skill.name}`;
                            const skillData = data.skills[skillKey];
                            const completed = skillData.completed.filter(Boolean).length;
                            const total = skillData.completed.length;
                            const percent = ((completed / total) * 100).toFixed(0);
                            
                            let status = 'Needs Practice';
                            if (percent == 100) status = '‚úì Mastered';
                            else if (percent >= 70) status = 'Proficient';
                            else if (percent >= 40) status = 'Developing';
                            
                            sheetData.push([
                                zone,
                                skill.name,
                                completed,
                                total,
                                percent + '%',
                                skillData.assessmentCount || 0,
                                skillData.repCount || 0,
                                `${skillData.bestScore || 0}/${total}`,
                                status
                            ]);
                        });
                    });
                    
                    // Add detailed checkpoints
                    sheetData.push([]);
                    sheetData.push(['DETAILED ASSESSMENT POINTS']);
                    sheetData.push(['Skill', 'Assessment Point', 'Status']);
                    
                    Object.keys(SKILLS_DATA).forEach(zone => {
                        SKILLS_DATA[zone].forEach(skill => {
                            const skillKey = `${zone}_${skill.name}`;
                            const skillData = data.skills[skillKey];
                            
                            sheetData.push([`${zone} - ${skill.name}`, '', '']);
                            skill.items.forEach((item, index) => {
                                sheetData.push([
                                    '',
                                    item,
                                    skillData.completed[index] ? '‚úì Complete' : '‚óã Incomplete'
                                ]);
                            });
                        });
                    });
                    
                    // Add feedback if exists
                    if (feedbackData[student.id] && Object.keys(feedbackData[student.id]).length > 0) {
                        sheetData.push([]);
                        sheetData.push(['TRAINER FEEDBACK']);
                        sheetData.push(['Skill', 'Feedback']);
                        
                        Object.keys(feedbackData[student.id]).forEach(skillKey => {
                            const feedback = feedbackData[student.id][skillKey];
                            if (feedback) {
                                const skillName = skillKey.split('_').slice(1).join(' ');
                                sheetData.push([skillName, feedback]);
                            }
                        });
                    }
                    
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    ws['!cols'] = [{wch: 15}, {wch: 40}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 12}, {wch: 14}, {wch: 12}, {wch: 15}];
                    
                    // Truncate name for sheet name (max 31 chars)
                    const sheetName = student.name.substring(0, 28).replace(/[^a-zA-Z0-9 ]/g, '');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                const filename = `All-Students-Report-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                hideLoading();
                showNotification(`‚úÖ Complete report with ${activeStudents.length} students downloaded!`, 'success');
                console.log('‚úÖ All students Excel report generated:', filename);
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Export error:', error);
                alert('Export failed: ' + error.message + '\n\nCheck console (F12) for details.');
                showNotification('‚ùå Export failed: ' + error.message, 'error');
            }
            }, 100);
        }

        function printReport() {
            const studentId = document.getElementById('reportStudent').value;
            if (!studentId) {
                alert('Please select a student and generate a report first.');
                return;
            }
            
            const element = document.getElementById('reportContent');
            if (!element || element.innerHTML.length < 100) {
                alert('Please generate a report first by clicking "üìä Generate Report".');
                return;
            }
            
            const student = STUDENTS.find(s => s.id == studentId);
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${student.name} - Performance Report</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 20px; 
                            max-width: 1200px; 
                            margin: 0 auto; 
                        }
                        .report-header { 
                            text-align: center; 
                            background: #1e3c72; 
                            color: white; 
                            padding: 20px; 
                            border-radius: 10px; 
                            margin-bottom: 20px; 
                        }
                        .report-section { 
                            margin-bottom: 30px; 
                            page-break-inside: avoid; 
                        }
                        .report-section h3 { 
                            color: #1e3c72; 
                            border-bottom: 2px solid #1e3c72; 
                            padding-bottom: 10px; 
                        }
                        .stat-card { 
                            display: inline-block; 
                            padding: 15px; 
                            margin: 10px; 
                            border-radius: 8px; 
                            background: #f8f9fa; 
                        }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${element.innerHTML}
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #1e3c72; color: white; border: none; cursor: pointer; border-radius: 5px;">
                            üñ®Ô∏è Print This Report
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; cursor: pointer; border-radius: 5px; margin-left: 10px;">
                            Close
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            showNotification('‚úÖ Print preview opened in new window', 'success');
        }

        function testPDFExport() {
            console.log('üß™ Testing PDF Export System...');
            
            const checks = {
                'html2pdf library': typeof html2pdf !== 'undefined',
                'Student selected': !!document.getElementById('reportStudent').value,
                'Report content exists': !!document.getElementById('reportContent'),
                'Report has content': document.getElementById('reportContent').innerHTML.length > 100
            };
            
            console.log('Test Results:', checks);
            
            let message = 'üß™ PDF Export Test Results:\n\n';
            let allPass = true;
            
            for (const [test, result] of Object.entries(checks)) {
                message += `${result ? '‚úÖ' : '‚ùå'} ${test}\n`;
                if (!result) allPass = false;
            }
            
            if (allPass) {
                message += '\n‚úÖ All checks passed! PDF export should work.';
                message += '\n\nClick "üìÑ Export PDF" to try it.';
            } else {
                message += '\n\n‚ùå Some checks failed. Fix these issues:';
                if (!checks['html2pdf library']) message += '\n‚Ä¢ html2pdf library not loaded - reload page';
                if (!checks['Student selected']) message += '\n‚Ä¢ Select a student from dropdown';
                if (!checks['Report has content']) message += '\n‚Ä¢ Generate a report first';
            }
            
            alert(message);
            
            if (allPass) {
                const proceed = confirm('All tests passed! Try exporting PDF now?');
                if (proceed) {
                    exportReportPDF();
                }
            }
        }

        function exportReportPDF() {
            console.log('üîç Starting PDF export...');
            
            const studentId = document.getElementById('reportStudent').value;
            if (!studentId) {
                showNotification('‚ùå Please select a student first!', 'error');
                alert('Please select a student from the dropdown first.');
                return;
            }

            const student = STUDENTS.find(s => s.id == studentId);
            if (!student) {
                showNotification('‚ùå Student not found!', 'error');
                return;
            }
            
            const element = document.getElementById('reportContent');
            
            // Check if report content exists and has content
            if (!element || !element.innerHTML || element.innerHTML.trim().length < 100) {
                showNotification('‚ùå No report to export! Generate a report first.', 'error');
                alert('Please generate a report first by clicking "üìä Generate Report" button.');
                return;
            }

            console.log('‚úÖ Student:', student.name);
            console.log('‚úÖ Report content found, length:', element.innerHTML.length);
            
            showNotification('üìÑ Generating PDF... Please wait...', 'info');
            
            try {
                const filename = `${student.name.replace(/[^a-zA-Z0-9]/g, '-')}-report-${new Date().toISOString().split('T')[0]}.pdf`;
                console.log('üìÑ Filename:', filename);
                
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Use html2pdf library
                html2pdf()
                    .set(opt)
                    .from(element)
                    .save()
                    .then(() => {
                        console.log('‚úÖ PDF saved successfully');
                        showNotification('‚úÖ PDF report generated successfully!', 'success');
                    })
                    .catch((error) => {
                        console.error('‚ùå PDF generation error:', error);
                        showNotification('‚ùå Error generating PDF: ' + error.message, 'error');
                        alert('PDF generation failed. Error: ' + error.message);
                    });
                    
            } catch (error) {
                console.error('‚ùå PDF export error:', error);
                showNotification('‚ùå Error exporting PDF: ' + error.message, 'error');
                alert('PDF export failed. Please try:\n1. Generate the report first\n2. Try a different browser\n3. Check browser console (F12) for details');
            }
        }

        function exportWeeklyReports() {
            showNotification('Generating weekly reports for all students...', 'info');
            
            STUDENTS.forEach((student, index) => {
                setTimeout(() => {
                    document.getElementById('reportStudent').value = student.id;
                    generateStudentReport();
                    
                    setTimeout(() => {
                        exportReportPDF();
                    }, 500);
                }, index * 2000);
            });
        }

        function importOldData() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files[0]) {
                showNotification('Please select a file to import!', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let oldData = JSON.parse(e.target.result);
                    let importedCount = 0;
                    let skippedCount = 0;

                    // Check if this is the old dashboard format (skill-based) or new format (student-based)
                    const isOldFormat = oldData.hasOwnProperty('Recovery Position') || 
                                       oldData.hasOwnProperty('Burn Management') ||
                                       oldData.hasOwnProperty('Triangular Bandage Sling') ||
                                       oldData.hasOwnProperty('SAM Splint (Ankle)');

                    if (isOldFormat) {
                        console.log('üì• Detected OLD dashboard format - converting...');
                        
                        // Old format: { "Skill Name": { "Student Name": [checkboxes] } }
                        // Map old skill names to new skill keys
                        const skillMapping = {
                            'Recovery Position': 'Yellow Zone_Recovery Position',
                            'Burn Management': 'Yellow Zone_Burn Management',
                            'Triangular Bandage Sling': 'Yellow Zone_Triangular Bandage - Shoulder Sprain',
                            'SAM Splint (Ankle)': 'Yellow Zone_Ankle Fracture Splinting'
                        };

                        // Process each skill from old data
                        Object.keys(skillMapping).forEach(oldSkillName => {
                            if (!oldData[oldSkillName]) return;
                            
                            const newSkillKey = skillMapping[oldSkillName];
                            console.log(`Processing: ${oldSkillName} ‚Üí ${newSkillKey}`);

                            // Process each student's data for this skill
                            Object.keys(oldData[oldSkillName]).forEach(oldStudentName => {
                                // Find matching student in new system
                                const matchedStudent = STUDENTS.find(s => {
                                    const sName = s.name.toLowerCase();
                                    const oldName = oldStudentName.toLowerCase();
                                    // Try exact match first
                                    if (sName === oldName) return true;
                                    // Try partial match (first and last name)
                                    const sWords = sName.split(' ');
                                    const oldWords = oldName.split(' ');
                                    return sWords[0] === oldWords[0] || sWords[sWords.length-1] === oldWords[oldWords.length-1];
                                });

                                if (matchedStudent) {
                                    const checkboxStates = oldData[oldSkillName][oldStudentName];
                                    
                                    // Import the checkbox states
                                    if (studentData[matchedStudent.id] && 
                                        studentData[matchedStudent.id].skills[newSkillKey]) {
                                        
                                        const currentSkill = studentData[matchedStudent.id].skills[newSkillKey];
                                        
                                        // Copy checkbox states (handle different array lengths)
                                        checkboxStates.forEach((state, index) => {
                                            if (index < currentSkill.completed.length) {
                                                currentSkill.completed[index] = state;
                                            }
                                        });
                                        
                                        currentSkill.lastAssessed = new Date().toISOString();
                                        importedCount++;
                                        
                                        console.log(`‚úÖ Imported ${oldSkillName} for ${matchedStudent.name}`);
                                    }
                                } else {
                                    console.warn(`‚ö†Ô∏è No match found for student: ${oldStudentName}`);
                                    skippedCount++;
                                }
                            });
                        });

                        showNotification(`‚úÖ Import complete! ${importedCount} skills imported, ${skippedCount} skipped.`, 'success');
                        
                    } else if (oldData.studentData) {
                        // New format backup file
                        console.log('üì• Detected NEW dashboard backup format...');
                        
                        if (oldData.studentData) {
                            Object.keys(oldData.studentData).forEach(key => {
                                if (studentData[key]) {
                                    // Merge skills data carefully
                                    Object.keys(oldData.studentData[key].skills || {}).forEach(skillKey => {
                                        if (studentData[key].skills[skillKey]) {
                                            studentData[key].skills[skillKey] = oldData.studentData[key].skills[skillKey];
                                            importedCount++;
                                        }
                                    });
                                }
                            });
                        }
                        
                        if (oldData.trainingHoursLog) {
                            trainingHoursLog = oldData.trainingHoursLog;
                        }
                        
                        if (oldData.feedbackData) {
                            feedbackData = oldData.feedbackData;
                        }
                        
                        showNotification(`‚úÖ Backup restored! ${importedCount} records imported.`, 'success');
                    } else {
                        showNotification('‚ö†Ô∏è Unrecognized file format. Please check the import guide.', 'error');
                        return;
                    }

                    // Update last updated timestamps
                    Object.keys(studentData).forEach(studentId => {
                        studentData[studentId].lastUpdated = new Date().toISOString();
                    });

                    saveToLocalStorage();
                    renderStudentRoster();
                    renderHoursLog();
                    
                    console.log('‚úÖ Import completed successfully!');
                    console.log(`üìä Statistics: ${importedCount} imported, ${skippedCount} skipped`);
                    
                    // Show import summary
                    setTimeout(() => {
                        alert(`Import Summary:\n\n‚úÖ Successfully imported: ${importedCount}\n‚ö†Ô∏è Skipped (no match): ${skippedCount}\n\nGo to the Assessment tab to verify your data.\nDon't forget to save!`);
                        location.reload();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('‚ùå Error importing data. Check console for details.', 'error');
                    alert(`Import Error:\n\n${error.message}\n\nPlease check:\n1. File is valid JSON\n2. File is not corrupted\n3. Browser console (F12) for details`);
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        function confirmClearAll() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data including assessments, hours, and feedback. This cannot be undone!\n\nAre you absolutely sure?')) {
                if (confirm('Please confirm again. All data will be permanently lost!')) {
                    localStorage.removeItem('emiratesSkillsData');
                    showNotification('All data cleared. Reloading...', 'info');
                    setTimeout(() => location.reload(), 1500);
                }
            }
        }

        function updateSystemInfo() {
            const totalRecords = trainingHoursLog.length;
            const totalFeedback = Object.values(feedbackData).reduce((sum, student) => sum + Object.keys(student).length, 0);
            const lastSaved = localStorage.getItem('emiratesSkillsData') ? 
                JSON.parse(localStorage.getItem('emiratesSkillsData')).lastSaved : 'Never';

            document.getElementById('systemInfo').innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>Total Students:</strong></td>
                        <td style="padding: 10px;">${STUDENTS.length}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>Total Training Records:</strong></td>
                        <td style="padding: 10px;">${totalRecords}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>Feedback Entries:</strong></td>
                        <td style="padding: 10px;">${totalFeedback}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;"><strong>Last Saved:</strong></td>
                        <td style="padding: 10px;">${lastSaved !== 'Never' ? new Date(lastSaved).toLocaleString() : 'Never'}</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px;"><strong>Days Until Competition:</strong></td>
                        <td style="padding: 10px;">${document.getElementById('daysLeft').textContent} days</td>
                    </tr>
                </table>
            `;
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ==================== INITIALIZE ON LOAD ====================
        // ==================== LOADING OVERLAY ====================
        function showLoading(message = 'Processing...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ==================== STUDENT MANAGEMENT ====================
        function getActiveStudents() {
            return STUDENTS.filter(s => !studentData[s.id]?.excluded);
        }

        function renderStudentManagement() {
            const tbody = document.getElementById('studentManagementBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            STUDENTS.forEach(student => {
                const data = studentData[student.id];
                const isExcluded = data.excluded || false;
                
                const row = document.createElement('tr');
                row.style.background = isExcluded ? '#f8d7da' : 'white';
                row.innerHTML = `
                    <td><strong>${student.name}</strong></td>
                    <td>${data.totalHours} hrs</td>
                    <td>
                        <span style="padding: 5px 12px; border-radius: 15px; font-weight: bold; background: ${isExcluded ? '#dc3545' : '#28a745'}; color: white;">
                            ${isExcluded ? '‚ùå Excluded' : '‚úÖ Active'}
                        </span>
                    </td>
                    <td>
                        ${isExcluded ? `
                            <button class="btn btn-success" onclick="reactivateStudent(${student.id})" style="padding: 6px 12px; font-size: 0.9em;">
                                ‚úÖ Reactivate
                            </button>
                        ` : `
                            <button class="btn btn-warning" onclick="excludeStudent(${student.id})" style="padding: 6px 12px; font-size: 0.9em;">
                                ‚ö†Ô∏è Exclude
                            </button>
                        `}
                        <button class="btn btn-danger" onclick="deleteStudent(${student.id})" style="padding: 6px 12px; font-size: 0.9em; margin-left: 5px;">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function excludeStudent(studentId) {
            const student = STUDENTS.find(s => s.id == studentId);
            if (!student) return;
            
            if (confirm(`Exclude ${student.name} from competition?\n\nTheir data will be preserved but hidden from reports and statistics. You can reactivate them anytime.`)) {
                studentData[studentId].excluded = true;
                studentData[studentId].excludedDate = new Date().toISOString();
                saveToLocalStorage();
                renderStudentManagement();
                showNotification(`${student.name} excluded from competition`, 'info');
                
                // Refresh displays
                renderStudentRoster();
                renderAllAnalytics();
            }
        }

        function reactivateStudent(studentId) {
            const student = STUDENTS.find(s => s.id == studentId);
            if (!student) return;
            
            if (confirm(`Reactivate ${student.name} for competition?\n\nThey will be included in all reports and statistics again.`)) {
                studentData[studentId].excluded = false;
                studentData[studentId].excludedDate = null;
                saveToLocalStorage();
                renderStudentManagement();
                showNotification(`${student.name} reactivated!`, 'success');
                
                // Refresh displays
                renderStudentRoster();
                renderAllAnalytics();
            }
        }

        function deleteStudent(studentId) {
            const student = STUDENTS.find(s => s.id == studentId);
            if (!student) return;
            
            if (confirm(`‚ö†Ô∏è PERMANENTLY DELETE ${student.name}?\n\nThis will remove ALL their data including:\n- Training hours\n- Skills assessments\n- Feedback\n- History\n\nThis CANNOT be undone!\n\nType the student's first name to confirm.`)) {
                const firstName = student.name.split(' ')[0];
                const userInput = prompt(`Type "${firstName}" to confirm deletion:`);
                
                if (userInput === firstName) {
                    // Remove from STUDENTS array
                    const index = STUDENTS.findIndex(s => s.id == studentId);
                    if (index > -1) {
                        STUDENTS.splice(index, 1);
                    }
                    
                    // Delete data
                    delete studentData[studentId];
                    delete feedbackData[studentId];
                    
                    // Remove from training logs
                    trainingHoursLog = trainingHoursLog.filter(log => log.studentId != studentId);
                    
                    saveToLocalStorage();
                    renderStudentManagement();
                    populateStudentSelectors();
                    renderStudentRoster();
                    showNotification(`${student.name} permanently deleted`, 'info');
                } else {
                    alert('Deletion cancelled - name did not match');
                }
            }
        }

        // ==================== BULK TRAINING HOURS ====================
        function renderBulkStudentsCheckboxes() {
            const container = document.getElementById('bulkStudentsCheckboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            STUDENTS.forEach(student => {
                const data = studentData[student.id];
                const isExcluded = data.excluded || false;
                
                if (!isExcluded) {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px;';
                    div.innerHTML = `
                        <input type="checkbox" class="bulk-student-checkbox" value="${student.id}" 
                               id="bulk-student-${student.id}" style="width: 18px; height: 18px; cursor: pointer;" />
                        <label for="bulk-student-${student.id}" style="cursor: pointer;">${student.name}</label>
                    `;
                    container.appendChild(div);
                }
            });
            
            // Set today's date
            document.getElementById('bulkHoursDate').valueAsDate = new Date();
        }

        function toggleAllStudents() {
            const selectAll = document.getElementById('selectAllStudents');
            const checkboxes = document.querySelectorAll('.bulk-student-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function addBulkHours() {
            const date = document.getElementById('bulkHoursDate').value;
            const hours = parseFloat(document.getElementById('bulkHoursAmount').value);
            const notes = document.getElementById('bulkHoursNotes').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            if (!hours || isNaN(hours) || hours <= 0) {
                alert('‚ùå Please enter valid hours (must be greater than 0)');
                return;
            }
            
            if (hours > 24) {
                alert('‚ùå Hours cannot exceed 24 per day. Please check your entry.');
                return;
            }
            
            if (hours > 12) {
                if (!confirm(`‚ö†Ô∏è You entered ${hours} hours.\n\nThis is more than a typical training day.\n\nAre you sure this is correct?`)) {
                    return;
                }
            }
            
            const selectedStudents = [];
            document.querySelectorAll('.bulk-student-checkbox:checked').forEach(cb => {
                selectedStudents.push(parseInt(cb.value));
            });
            
            if (selectedStudents.length === 0) {
                alert('Please select at least one student');
                return;
            }
            
            const studentNames = selectedStudents.map(id => STUDENTS.find(s => s.id == id).name).join(', ');
            
            if (confirm(`Add ${hours} hours to ${selectedStudents.length} student(s)?\n\nStudents: ${studentNames}\nDate: ${date}\nHours: ${hours}\nNotes: ${notes || '(none)'}`)) {
                
                let added = 0;
                selectedStudents.forEach(studentId => {
                    // Add to training log
                    trainingHoursLog.push({
                        id: Date.now() + Math.random(),
                        studentId: studentId,
                        date: date,
                        hours: hours,
                        notes: notes || 'Group training session',
                        timestamp: new Date().toISOString()
                    });
                    
                    // Update total hours
                    studentData[studentId].totalHours += hours;
                    studentData[studentId].lastUpdated = new Date().toISOString();
                    added++;
                });
                
                saveToLocalStorage();
                showNotification(`‚úÖ Added ${hours} hours to ${added} students!`, 'success');
                
                // Clear form
                document.getElementById('bulkHoursAmount').value = 2;
                document.getElementById('bulkHoursNotes').value = '';
                document.getElementById('selectAllStudents').checked = false;
                document.querySelectorAll('.bulk-student-checkbox').forEach(cb => cb.checked = false);
                
                // Refresh displays
                renderStudentRoster();
                renderHoursLog();
                renderAllAnalytics();
                
                alert(`Success!\n\n‚úÖ ${hours} hours added to ${added} students\nüìä Total hours logged: ${(hours * added).toFixed(1)}`);
            }
        }

        window.onload = initializeApp;

        // Prevent data loss - warn if unsaved rep counts exist
        window.addEventListener('beforeunload', (e) => {
            // Check for unsaved rep counts (yellow colored numbers)
            const tempElements = document.querySelectorAll('[id^="tempRepCount-"]');
            for (let elem of tempElements) {
                if (elem && window.getComputedStyle(elem).color === 'rgb(255, 193, 7)') {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved rep counts! Click "Save Reps" before leaving.';
                    return e.returnValue;
                }
            }
            
            // Check for any visible save buttons (indicates unsaved changes)
            const saveButtons = document.querySelectorAll('[id^="repButtons-"]');
            for (let btn of saveButtons) {
                if (btn && btn.style.display === 'flex') {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes! Click "Save Reps" before leaving.';
                    return e.returnValue;
                }
            }
        });

        // Auto-save every 5 minutes
        setInterval(() => {
            saveToLocalStorage();
            console.log('Auto-saved at', new Date().toLocaleTimeString());
        }, 300000);
    </script>
</body>
</html>
